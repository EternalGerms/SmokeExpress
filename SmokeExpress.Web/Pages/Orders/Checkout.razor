@page "/checkout"
@using SmokeExpress.Web.Models
@using System.Text.Json
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject IProductService ProductService
@inject IAddressService AddressService
@inject AuthenticationStateProvider AuthStateProvider
@inject IOrderService OrderService

<h3>Finalizar Pedido</h3>

@if (_loading)
{
    <p>Carregando carrinho...</p>
}
else if (_itens is null || _itens.Count == 0)
{
    <div class="alert alert-warning">Seu carrinho está vazio.</div>
}
else
{
    <div class="row">
        <div class="col-md-7">
            <h5>Itens do Carrinho</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th class="text-end">Preço Unitário</th>
                        <th class="text-end">Qtd</th>
                        <th class="text-end">Subtotal</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in _vmItens)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    @if (!string.IsNullOrWhiteSpace(item.ImagemUrl))
                                    {
                                        <img src="@item.ImagemUrl" alt="@item.Nome" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" />
                                    }
                                    <span>@item.Nome</span>
                                </div>
                            </td>
                            <td class="text-end">@item.PrecoUnitario.ToString("C")</td>
                            <td class="text-end" style="width:160px;">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            @onclick="() => OnQuantityChanged(item.ProductId, item.Quantidade - 1)">−</button>
                                    <InputNumber Value="@item.Quantidade"
                                                 ValueChanged="(int v) => OnQuantityChanged(item.ProductId, v)"
                                                 ValueExpression="() => item.Quantidade"
                                                 class="form-control text-end"
                                                 min="1" />
                                    <button class="btn btn-outline-secondary"
                                            type="button"
                                            @onclick="() => OnQuantityChanged(item.ProductId, item.Quantidade + 1)">+</button>
                                </div>
                            </td>
                            <td class="text-end">@item.Subtotal.ToString("C")</td>
                            <td class="text-end" style="width:90px;">
                                <button type="button" class="btn btn-sm btn-outline-danger" title="Remover"
                                        @onclick="() => RemoverItemAsync(item.ProductId)">
                                    Remover
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
                        <tfoot>
                    <tr>
                                <th colspan="3" class="text-end">Subtotal</th>
                                <th class="text-end">@_total.ToString("C")</th>
                        <th></th>
                    </tr>
                            <tr>
                                <th colspan="3" class="text-end">Frete</th>
                                <th class="text-end">@_frete.ToString("C")</th>
                                <th></th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Total</th>
                                <th class="text-end">@((_total + _frete).ToString("C"))</th>
                                <th></th>
                            </tr>
                </tfoot>
            </table>
        </div>
        <div class="col-md-5">
            <AuthorizeView>
                <Authorized>
                    <h5>Endereço de Entrega</h5>
                    <div class="mb-2">
                        <label class="form-label">Usar endereço salvo</label>
                        <div class="d-flex gap-2">
                            <select class="form-select" @onchange="OnEnderecoSelecionado">
                                <option value="">Selecionar...</option>
                                @foreach (var a in _enderecosSalvos)
                                {
                                    <option value="@a.Id">@FormatEndereco(a)</option>
                                }
                            </select>
                            <button type="button" class="btn btn-outline-primary" @onclick="AbrirNovoEndereco">Adicionar</button>
                            <a class="btn btn-outline-secondary" href="/account/addresses">Gerenciar</a>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" @onclick="AbrirPagamento" disabled="@_submitting">Finalizar Pedido</button>
                        <a href="/produtos" class="btn btn-outline-secondary">Continuar comprando</a>
                        <button type="button" class="btn btn-outline-danger" @onclick="LimparCarrinhoAsync">Limpar carrinho</button>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(_error))
                    {
                        <div class="text-danger mt-2">@_error</div>
                    }
                </Authorized>
                <NotAuthorized>
                    <div class="alert alert-info">Você precisa entrar para finalizar o pedido.</div>
                    <a class="btn btn-outline-primary" href="/account/login?returnUrl=%2Fcheckout">Entrar</a>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
}

@* Modal de novo endereço *@
@if (_showNovoEndereco)
{
    <div class="modal fade show" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo endereço</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CancelarNovoEndereco"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="_novoEndereco" OnValidSubmit="SalvarNovoEnderecoAsync">
                        <DataAnnotationsValidator />
                        <div class="mb-2">
                            <label class="form-label">Rua</label>
                            <InputText class="form-control" @bind-Value="_novoEndereco.Rua" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Número</label>
                            <input class="form-control" @bind="NovoNumeroBinding" @bind:event="oninput" inputmode="numeric" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Cidade</label>
                            <InputText class="form-control" @bind-Value="_novoEndereco.Cidade" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Bairro</label>
                            <InputText class="form-control" @bind-Value="_novoEndereco.Bairro" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Complemento</label>
                            <InputText class="form-control" @bind-Value="_novoEndereco.Complemento" />
                        </div>
                        <div class="form-check mb-2">
                            <InputCheckbox class="form-check-input" @bind-Value="_novoEndereco.IsDefault" />
                            <label class="form-check-label">Marcar como padrão</label>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                            <button type="button" class="btn btn-secondary" @onclick="CancelarNovoEndereco">Cancelar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@* Modal de pagamento *@
@if (_showPagamento)
{
    <div class="modal fade show" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pagamento</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="() => _showPagamento = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Escolha o método</label>
                        <select class="form-select" @bind="_pagamentoMetodo">
                            <option value="">Selecionar...</option>
                            <option value="pix">PIX</option>
                            <option value="cartao">Cartão de crédito</option>
                            <option value="boleto">Boleto bancário</option>
                        </select>
                    </div>

                    @if (_pagamentoMetodo == "pix")
                    {
                        <div class="card p-3 mb-2">
                            <h6>PIX - Copia e Cola</h6>
                            <div class="mb-2">
                                <textarea class="form-control" rows="3" readonly>@_pixCode</textarea>
                            </div>
                            <div class="mb-2">
                                <img alt="QR Code PIX" src="@GerarQrSvgDataUri(_pixCode)" style="width:180px;height:180px;border:1px solid #eee;" />
                            </div>
                            <button class="btn btn-success" @onclick="ConfirmarPagamentoAsync">Pago</button>
                        </div>
                    }
                    else if (_pagamentoMetodo == "cartao")
                    {
                        <EditForm Model="_cartao" OnValidSubmit="ConfirmarPagamentoAsync">
                            <DataAnnotationsValidator />
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Número do cartão</label>
                                    <input class="form-control" @bind="_cartao.Numero" maxlength="19" placeholder="0000 0000 0000 0000" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Validade (MM/AA)</label>
                                    <input class="form-control" @bind="_cartao.Validade" maxlength="5" placeholder="MM/AA" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">CVV</label>
                                    <input class="form-control" @bind="_cartao.Cvv" maxlength="4" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Nome impresso</label>
                                    <input class="form-control" @bind="_cartao.Nome" />
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" type="submit">Pagar</button>
                            </div>
                        </EditForm>
                    }
                    else if (_pagamentoMetodo == "boleto")
                    {
                        <div class="card p-3 mb-2">
                            <h6>Boleto bancário</h6>
                            <div class="mb-2">
                                <input class="form-control" value="@_boletoCodigo" readonly />
                            </div>
                            <button class="btn btn-success" @onclick="ConfirmarPagamentoAsync">Pago</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@code {
    private bool _loading = true;
    private bool _submitting = false;
    private string? _error;
    private List<CartItemDto> _itens = new();
    private List<CartItemViewModel> _vmItens = new();
    private EnderecoEntregaDto _endereco = new();
    private decimal _total = 0m;
    private decimal _frete = 0m;
    private bool _showPagamento;
    private string? _pagamentoMetodo; // pix | cartao | boleto
    private string _pixCode = string.Empty;
    private string _boletoCodigo = string.Empty;
    private CartaoDto _cartao = new();

    private bool _loadedFromJs;

    private List<AddressDto> _enderecosSalvos = new();
    private bool _showNovoEndereco;
    private AddressDto _novoEndereco = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_loadedFromJs)
        {
            await LoadCartAsync();
            _loading = false;
            _loadedFromJs = true;
            // Após primeira renderização, JS interop está disponível: carrega endereços e define frete
            await CarregarEnderecosAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadCartAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "cart");
            if (!string.IsNullOrWhiteSpace(json))
            {
                _itens = System.Text.Json.JsonSerializer.Deserialize<List<CartItemDto>>(json) ?? new();
                await HydrateCartViewAsync();
            }
        }
        catch (Exception)
        {
            _itens = new();
            _vmItens = new();
            _total = 0m;
        }
    }

    private async Task HydrateCartViewAsync()
    {
        _vmItens = new();
        _total = 0m;

        var ids = _itens.Select(i => i.ProductId).Distinct().ToArray();
        var client = HttpClientFactory.CreateClient();
        var productsUri = new Uri(new Uri(Nav.BaseUri), "api/products/by-ids");
        var response = await client.PostAsJsonAsync(productsUri, ids);
        var produtos = new Dictionary<int, ProductLite>();
        if (response.IsSuccessStatusCode)
        {
            var list = await response.Content.ReadFromJsonAsync<List<ProductLite>>() ?? new();
            produtos = list.ToDictionary(p => p.Id);
        }

        foreach (var item in _itens)
        {
            if (!produtos.TryGetValue(item.ProductId, out var p))
            {
                continue;
            }

            var subtotal = p.Preco * item.Quantidade;
            _vmItens.Add(new CartItemViewModel
            {
                ProductId = p.Id,
                Nome = p.Nome,
                Quantidade = item.Quantidade,
                PrecoUnitario = p.Preco,
                Subtotal = subtotal,
                ImagemUrl = p.ImagemUrl ?? string.Empty
            });
            _total += subtotal;
        }
    }

    private sealed class ProductLite
    {
        public int Id { get; set; }
        public string Nome { get; set; } = string.Empty;
        public decimal Preco { get; set; }
        public string? ImagemUrl { get; set; }
    }

    private sealed class AddressDto
    {
        public int Id { get; set; }
        public string Rua { get; set; } = string.Empty;
        public string? Numero { get; set; }
        public string Cidade { get; set; } = string.Empty;
        public string Bairro { get; set; } = string.Empty;
        public string? Complemento { get; set; }
        public bool IsDefault { get; set; }
    }

    private sealed class OrderCreatedDto
    {
        public int orderId { get; set; }
    }

    private sealed class CartaoDto
    {
        public string Numero { get; set; } = string.Empty;
        public string Validade { get; set; } = string.Empty;
        public string Cvv { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
    }

    private async Task OnQuantityChanged(int productId, int novaQuantidade)
    {
        if (novaQuantidade < 1)
        {
            novaQuantidade = 1;
        }

        var item = _itens.FirstOrDefault(i => i.ProductId == productId);
        if (item is null)
        {
            return;
        }

        item.Quantidade = novaQuantidade;
        await SaveCartAsync();
        await HydrateCartViewAsync();
        StateHasChanged();
    }

    private async Task SaveCartAsync()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(_itens);
        await JS.InvokeVoidAsync("localStorage.setItem", "cart", json);
    }

    private async Task RemoverItemAsync(int productId)
    {
        var beforeCount = _itens.Count;
        _itens = _itens.Where(i => i.ProductId != productId).ToList();
        if (_itens.Count != beforeCount)
        {
            await SaveCartAsync();
            await HydrateCartViewAsync();
            StateHasChanged();
        }
    }

    private async Task LimparCarrinhoAsync()
    {
        _itens.Clear();
        await SaveCartAsync();
        await HydrateCartViewAsync();
        StateHasChanged();
    }

    // Removido: carregamento de endereços ocorre em OnAfterRenderAsync(firstRender)

    private async Task CarregarEnderecosAsync()
    {
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                _enderecosSalvos = new();
                return;
            }

            var list = await AddressService.ListAsync(userId);
            _enderecosSalvos = list.Select(a => new AddressDto
            {
                Id = a.Id,
                Rua = a.Rua,
                Numero = a.Numero,
                Cidade = a.Cidade,
                Bairro = a.Bairro,
                Complemento = a.Complemento,
                IsDefault = a.IsDefault
            }).ToList();

            var padrao = _enderecosSalvos.FirstOrDefault(a => a.IsDefault);
            if (padrao is not null)
            {
                PreencherEndereco(padrao);
                await DefinirFreteParaEnderecoAsync(padrao.Id);
            }
        }
        catch
        {
            _enderecosSalvos = new();
        }
    }

    private void AbrirNovoEndereco()
    {
        _novoEndereco = new AddressDto();
        _showNovoEndereco = true;
    }

    private void CancelarNovoEndereco()
    {
        _showNovoEndereco = false;
    }

    private async Task SalvarNovoEnderecoAsync()
    {
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                Nav.NavigateTo("/account/login?returnUrl=%2Fcheckout");
                return;
            }

            var entity = new Address
            {
                Rua = _novoEndereco.Rua,
                Numero = _novoEndereco.Numero,
                Cidade = _novoEndereco.Cidade,
                Bairro = _novoEndereco.Bairro,
                Complemento = _novoEndereco.Complemento,
                IsDefault = _novoEndereco.IsDefault
            };

            var created = await AddressService.CreateAsync(userId, entity);
            _showNovoEndereco = false;
            await CarregarEnderecosAsync();
            var dto = new AddressDto
            {
                Id = created.Id,
                Rua = created.Rua,
                Numero = created.Numero,
                Cidade = created.Cidade,
                Bairro = created.Bairro,
                Complemento = created.Complemento,
                IsDefault = created.IsDefault
            };
            PreencherEndereco(dto);
            await DefinirFreteParaEnderecoAsync(dto.Id);
        }
        catch { }
    }

    private string NovoNumeroBinding
    {
        get => _novoEndereco.Numero ?? string.Empty;
        set
        {
            var digits = new string((value ?? string.Empty).Where(char.IsDigit).ToArray());
            _novoEndereco.Numero = string.IsNullOrEmpty(digits) ? null : digits;
        }
    }

    private async Task<string> GetUserIdAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            return user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
        }
        return string.Empty;
    }

    

    private async void OnEnderecoSelecionado(ChangeEventArgs e)
    {
        if (e?.Value is null) return;
        if (int.TryParse(e.Value.ToString(), out var id))
        {
            var sel = _enderecosSalvos.FirstOrDefault(a => a.Id == id);
            if (sel is not null)
            {
                PreencherEndereco(sel);
                await DefinirFreteParaEnderecoAsync(sel.Id);
            }
        }
    }

    private void PreencherEndereco(AddressDto a)
    {
        _endereco.Rua = a.Rua;
        _endereco.Numero = a.Numero;
        _endereco.Cidade = a.Cidade;
        _endereco.Bairro = a.Bairro;
        _endereco.Complemento = a.Complemento;
        StateHasChanged();
    }

    private static string FormatEndereco(AddressDto a)
        => $"{a.Rua}, {a.Numero} - {a.Bairro}, {a.Cidade} {a.Complemento}";

    private async Task DefinirFreteParaEnderecoAsync(int addressId)
    {
        // Tenta ler frete salvo do localStorage
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "shipping");
            var map = string.IsNullOrWhiteSpace(json)
                ? new Dictionary<int, decimal>()
                : System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, decimal>>(json) ?? new Dictionary<int, decimal>();

            if (map.TryGetValue(addressId, out var saved))
            {
                _frete = saved;
                StateHasChanged();
                return;
            }

            // Gera uma vez e persiste
            var rnd = new Random();
            var valor = rnd.NextDouble() * (20.0 - 10.0) + 10.0; // 10 a 20
            _frete = Math.Round((decimal)valor, 2);
            map[addressId] = _frete;
            var novoJson = System.Text.Json.JsonSerializer.Serialize(map);
            await JS.InvokeVoidAsync("localStorage.setItem", "shipping", novoJson);
            StateHasChanged();
        }
        catch
        {
            // fallback local
            var rnd = new Random();
            var valor = rnd.NextDouble() * (20.0 - 10.0) + 10.0;
            _frete = Math.Round((decimal)valor, 2);
        }
    }

    private string GerarCodigoPix()
    {
        var valor = (_total + _frete).ToString("F2").Replace(',', '.');
        var code = $"000201PIX-DEMOSMOKE|ORD={DateTime.UtcNow.Ticks}|VAL={valor}|CRC=ABCD";
        return code;
    }

    private string GerarBoleto()
    {
        var rnd = new Random();
        var sb = new System.Text.StringBuilder();
        for (int i = 0; i < 47; i++) sb.Append(rnd.Next(0, 10));
        return sb.ToString();
    }

    private string GerarQrSvgDataUri(string text)
    {
        // Placeholder simples: um SVG com o texto centralizado (não é um QR real)
        var safe = System.Net.WebUtility.HtmlEncode(text);
        var svg = $"<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'><rect width='100%' height='100%' fill='white'/><rect x='10' y='10' width='160' height='160' fill='none' stroke='#000'/><text x='90' y='95' font-size='10' text-anchor='middle' fill='#000'>{safe}</text></svg>";
        var uri = "data:image/svg+xml;utf8," + System.Net.WebUtility.UrlEncode(svg);
        return uri;
    }

    // Removido: bindings de campos manuais; checkout usa apenas endereços salvos

    private void AbrirPagamento()
    {
        _error = null;
        if (_itens.Count == 0)
        {
            _error = "Seu carrinho está vazio.";
            return;
        }
        _showPagamento = true;
        _pagamentoMetodo = null;
        _pixCode = GerarCodigoPix();
        _boletoCodigo = GerarBoleto();
    }

    private async Task ConfirmarPagamentoAsync()
    {
        _error = null;
        _submitting = true;
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                _error = "Sessão expirada. Faça login para finalizar o pedido.";
                return;
            }

            var orderId = await OrderService.CriarPedidoAsync(userId, _itens, _endereco, _frete);
            await JS.InvokeVoidAsync("localStorage.removeItem", "cart");
            _showPagamento = false;
            Nav.NavigateTo($"/pedido/confirmacao/{orderId}");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _submitting = false;
        }
    }
}


