@page "/checkout"
@using SmokeExpress.Web.Models
@using System.Text.Json
@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject IProductService ProductService
@inject IAddressService AddressService
@inject AuthenticationStateProvider AuthStateProvider
@inject IOrderService OrderService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.ShoppingCartCheckout" Size="Size.Large" Class="mr-2" />
        Finalizar Pedido
    </MudText>

    @if (_loading)
    {
        <MudStack Spacing="2" AlignItems="AlignItems.Center">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mud-width-full" />
            <MudText Typo="Typo.body1">Carregando carrinho...</MudText>
        </MudStack>
    }
    else if (_itens is null || _itens.Count == 0)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Elevation="1">
            Seu carrinho está vazio.
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            <MudItem xs="12" md="7">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Itens do Carrinho</MudText>

                    <MudTable T="CartItemViewModel"
                              Items="_vmItens"
                              Dense="true"
                              Hover="true"
                              FixedHeader="true"
                              Elevation="0"
                              Class="mud-width-full">
                        <HeaderContent>
                            <MudTh>Produto</MudTh>
                            <MudTh Class="text-end">Preço Unitário</MudTh>
                            <MudTh Class="text-end">Qtd</MudTh>
                            <MudTh Class="text-end">Subtotal</MudTh>
                            <MudTh Class="text-end">Ações</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    @if (!string.IsNullOrWhiteSpace(context.ImagemUrl))
                                    {
                                        <img src="@context.ImagemUrl"
                                             alt="@context.Nome"
                                             style="width:40px;height:40px;object-fit:cover;border-radius:4px;" />
                                    }
                                    <MudText Typo="Typo.body2">@context.Nome</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd Class="text-end">
                                <MudText Typo="Typo.body2">@context.PrecoUnitario.ToString("C")</MudText>
                            </MudTd>
                            <MudTd Class="text-end">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd" Spacing="1">
                                    <MudIconButton Icon="@Icons.Material.Filled.Remove"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => OnQuantityChanged(context.ProductId, context.Quantidade - 1))" />
                                    <MudNumericField T="int"
                                                     Value="context.Quantidade"
                                                     ValueChanged="(int v) => OnQuantityChanged(context.ProductId, v)"
                                                     Min="1"
                                                     Dense="true"
                                                     Class="mud-width-xs-4"
                                                     HideSpinButtons="true"
                                                     Variant="Variant.Outlined" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => OnQuantityChanged(context.ProductId, context.Quantidade + 1))" />
                                </MudStack>
                            </MudTd>
                            <MudTd Class="text-end">
                                <MudText Typo="Typo.body2">@context.Subtotal.ToString("C")</MudText>
                            </MudTd>
                            <MudTd Class="text-end">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="() => RemoverItemAsync(context.ProductId)">
                                    Remover
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    <MudDivider Class="my-3" />

                    <MudStack Spacing="1" AlignItems="AlignItems.End">
                        <MudText Typo="Typo.body2">
                            <strong>Subtotal:</strong> @_total.ToString("C")
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Frete:</strong> @_frete.ToString("C")
                        </MudText>
                        <MudText Typo="Typo.h6">
                            <strong>Total:</strong> @((_total + _frete).ToString("C"))
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="5">
                <AuthorizeView>
                    <Authorized>
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.h6" Class="mb-3">Endereço de Entrega</MudText>

                            <MudStack Spacing="2">
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1 d-block">
                                        Usar endereço salvo
                                    </MudText>
                                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                        <MudSelect T="int?" Value="_enderecoSelecionadoId" ValueChanged="OnEnderecoSelecionadoMud"
                                                   Label="Endereços"
                                                   Variant="Variant.Outlined"
                                                   Dense="true"
                                                   Class="flex-grow-1"
                                                   Style="min-width:0;">
                                            <MudSelectItem T="int?" Value="@null">Selecionar...</MudSelectItem>
                                            @foreach (var a in _enderecosSalvos)
                                            {
                                                <MudSelectItem T="int?" Value="@a.Id">@TruncarEndereco(FormatEndereco(a))</MudSelectItem>
                                            }
                                        </MudSelect>

                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   OnClick="AbrirNovoEndereco">
                                            Adicionar
                                        </MudButton>
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Default"
                                                   Size="Size.Small"
                                                   Href="/account/addresses">
                                            Gerenciar
                                        </MudButton>
                                    </MudStack>
                                </div>

                                @if (EnderecoSelecionado())
                                {
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                        <MudText Typo="Typo.caption" Color="Color.Success" Class="text-truncate"
                                                 Style="max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            @FormatEnderecoSelecionado()
                                        </MudText>
                                    </MudStack>
                                }
                                else
                                {
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                                        <MudText Typo="Typo.caption" Color="Color.Warning">
                                            Selecione um endereço de entrega para continuar.
                                        </MudText>
                                    </MudStack>
                                }

                                <MudStack Row="true" Spacing="2">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               OnClick="AbrirPagamento"
                                               Disabled="@(_submitting || !EnderecoSelecionado())">
                                        Finalizar Pedido
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Default"
                                               Href="/produtos">
                                        Continuar comprando
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               OnClick="LimparCarrinhoAsync">
                                        Limpar carrinho
                                    </MudButton>
                                </MudStack>

                                @if (!string.IsNullOrWhiteSpace(_error))
                                {
                                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
                                        @_error
                                    </MudAlert>
                                }
                            </MudStack>
                        </MudPaper>
                    </Authorized>
                    <NotAuthorized>
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudAlert Severity="Severity.Info" Class="mb-3">
                                Você precisa entrar para finalizar o pedido.
                            </MudAlert>
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Href="/account/login?returnUrl=%2Fcheckout">
                                Entrar
                            </MudButton>
                        </MudPaper>
                    </NotAuthorized>
                </AuthorizeView>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<NewAddressDialog Visible="_showNovoEndereco"
                  OnClose="OnNovoEnderecoFechado"
                  OnSaved="@(async id => await OnNovoEnderecoSalvo(id))" />

@* Modal de pagamento *@
@if (_showPagamento)
{
    <div class="modal fade show" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pagamento</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="() => _showPagamento = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Escolha o método</label>
                        <select class="form-select" @bind="_pagamentoMetodo">
                            <option value="">Selecionar...</option>
                            <option value="pix">PIX</option>
                            <option value="cartao">Cartão de crédito</option>
                            <option value="boleto">Boleto bancário</option>
                        </select>
                    </div>

                    @if (_pagamentoMetodo == "pix")
                    {
                        <div class="card p-3 mb-2">
                            <h6>PIX - Copia e Cola</h6>
                            <div class="mb-2">
                                <textarea class="form-control" rows="3" readonly>@_pixCode</textarea>
                            </div>
                            <div class="mb-2">
                                <img alt="QR Code PIX" src="@GerarQrSvgDataUri(_pixCode)" style="width:180px;height:180px;border:1px solid #eee;" />
                            </div>
                            <button class="btn btn-success" @onclick="ConfirmarPagamentoAsync">Pago</button>
                        </div>
                    }
                    else if (_pagamentoMetodo == "cartao")
                    {
                        <EditForm Model="_cartao" OnValidSubmit="ConfirmarPagamentoAsync">
                            <DataAnnotationsValidator />
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Número do cartão</label>
                                    <input class="form-control" @bind="_cartao.Numero" maxlength="19" placeholder="0000 0000 0000 0000" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Validade (MM/AA)</label>
                                    <input class="form-control" @bind="_cartao.Validade" maxlength="5" placeholder="MM/AA" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">CVV</label>
                                    <input class="form-control" @bind="_cartao.Cvv" maxlength="4" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Nome impresso</label>
                                    <input class="form-control" @bind="_cartao.Nome" />
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" type="submit">Pagar</button>
                            </div>
                        </EditForm>
                    }
                    else if (_pagamentoMetodo == "boleto")
                    {
                        <div class="card p-3 mb-2">
                            <h6>Boleto bancário</h6>
                            <div class="mb-2">
                                <input class="form-control" value="@_boletoCodigo" readonly />
                            </div>
                            <button class="btn btn-success" @onclick="ConfirmarPagamentoAsync">Pago</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}


@code {
    private bool _loading = true;
    private bool _submitting = false;
    private string? _error;
    private IReadOnlyList<CartItemDto> _itens = Array.Empty<CartItemDto>();
    private IReadOnlyList<CartItemViewModel> _vmItens = Array.Empty<CartItemViewModel>();
    private EnderecoEntregaDto _endereco = new();
    private int? _enderecoSelecionadoId;
    private decimal _total = 0m;
    private decimal _frete = 0m;
    private bool _showPagamento;
    private string? _pagamentoMetodo; // pix | cartao | boleto
    private string _pixCode = string.Empty;
    private string _boletoCodigo = string.Empty;
    private CartaoDto _cartao = new();

    private bool _loadedFromJs;

    private IReadOnlyList<AddressDto> _enderecosSalvos = Array.Empty<AddressDto>();
    private bool _showNovoEndereco;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_loadedFromJs)
        {
            await LoadCartAsync();
            _loading = false;
            _loadedFromJs = true;
            // Após primeira renderização, JS interop está disponível: carrega endereços e define frete
            await CarregarEnderecosAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadCartAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "cart");
            if (!string.IsNullOrWhiteSpace(json))
            {
                _itens = System.Text.Json.JsonSerializer.Deserialize<List<CartItemDto>>(json) ?? new();
                await HydrateCartViewAsync();
            }
        }
        catch (Exception)
        {
            _itens = Array.Empty<CartItemDto>();
            _vmItens = Array.Empty<CartItemViewModel>();
            _total = 0m;
        }
    }

    private async Task HydrateCartViewAsync()
    {
        var vmItensTemp = new List<CartItemViewModel>();
        _total = 0m;

        var ids = _itens.Select(i => i.ProductId).Distinct().ToArray();
        var client = HttpClientFactory.CreateClient();
        var productsUri = new Uri(new Uri(Nav.BaseUri), "api/products/by-ids");
        var response = await client.PostAsJsonAsync(productsUri, ids);
        var produtos = new Dictionary<int, ProductLite>();
        if (response.IsSuccessStatusCode)
        {
            var list = await response.Content.ReadFromJsonAsync<List<ProductLite>>() ?? new();
            produtos = list.ToDictionary(p => p.Id);
        }

        foreach (var item in _itens)
        {
            if (!produtos.TryGetValue(item.ProductId, out var p))
            {
                continue;
            }

            var subtotal = p.Preco * item.Quantidade;
            vmItensTemp.Add(new CartItemViewModel
            {
                ProductId = p.Id,
                Nome = p.Nome,
                Quantidade = item.Quantidade,
                PrecoUnitario = p.Preco,
                Subtotal = subtotal,
                ImagemUrl = p.ImagemUrl ?? string.Empty
            });
            _total += subtotal;
        }

        _vmItens = vmItensTemp;
    }

    private sealed class ProductLite
    {
        public int Id { get; set; }
        public string Nome { get; set; } = string.Empty;
        public decimal Preco { get; set; }
        public string? ImagemUrl { get; set; }
    }

    private sealed class AddressDto
    {
        public int Id { get; set; }
        public string Rua { get; set; } = string.Empty;
        public string? Numero { get; set; }
        public string Cidade { get; set; } = string.Empty;
        public string Bairro { get; set; } = string.Empty;
        public string? Complemento { get; set; }
        public bool IsDefault { get; set; }
        public string? Cep { get; set; }
    }

    private sealed class ViaCepResponse
    {
        public string? Cep { get; set; }
        public string? Logradouro { get; set; }
        public string? Bairro { get; set; }
        public string? Localidade { get; set; }
        public string? Uf { get; set; }
        public bool Erro { get; set; }
    }

    private sealed class OrderCreatedDto
    {
        public int orderId { get; set; }
    }

    private sealed class CartaoDto
    {
        public string Numero { get; set; } = string.Empty;
        public string Validade { get; set; } = string.Empty;
        public string Cvv { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
    }

    private async Task OnQuantityChanged(int productId, int novaQuantidade)
    {
        if (novaQuantidade < 1)
        {
            novaQuantidade = 1;
        }

        var item = _itens.FirstOrDefault(i => i.ProductId == productId);
        if (item is null)
        {
            return;
        }

        item.Quantidade = novaQuantidade;
        await SaveCartAsync();
        await HydrateCartViewAsync();
        StateHasChanged();
    }

    private async Task SaveCartAsync()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(_itens);
        await JS.InvokeVoidAsync("localStorage.setItem", "cart", json);
    }

    private async Task RemoverItemAsync(int productId)
    {
        var beforeCount = _itens.Count;
        _itens = _itens.Where(i => i.ProductId != productId).ToList();
        if (_itens.Count != beforeCount)
        {
            await SaveCartAsync();
            await HydrateCartViewAsync();
            StateHasChanged();
        }
    }

    private async Task LimparCarrinhoAsync()
    {
        _itens = Array.Empty<CartItemDto>();
        await SaveCartAsync();
        await HydrateCartViewAsync();
        StateHasChanged();
    }

    // Removido: carregamento de endereços ocorre em OnAfterRenderAsync(firstRender)

    private async Task CarregarEnderecosAsync()
    {
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                _enderecosSalvos = Array.Empty<AddressDto>();
                return;
            }

            var list = await AddressService.ListAsync(userId);
            _enderecosSalvos = list.Select(a => new AddressDto
            {
                Id = a.Id,
                Rua = a.Rua,
                Numero = a.Numero,
                Cidade = a.Cidade,
                Bairro = a.Bairro,
                Complemento = a.Complemento,
                IsDefault = a.IsDefault
            }).ToList();

            var padrao = _enderecosSalvos.FirstOrDefault(a => a.IsDefault);
            if (padrao is not null)
            {
                _enderecoSelecionadoId = padrao.Id;
                PreencherEndereco(padrao);
                await DefinirFreteParaEnderecoAsync(padrao.Id);
            }
        }
        catch
        {
            _enderecosSalvos = Array.Empty<AddressDto>();
        }
    }

    private void AbrirNovoEndereco()
    {
        _showNovoEndereco = true;
    }

    private void OnNovoEnderecoFechado()
    {
        _showNovoEndereco = false;
    }

    private async Task OnNovoEnderecoSalvo(int enderecoId)
    {
        _showNovoEndereco = false;
        await CarregarEnderecosAsync();

        _enderecoSelecionadoId = enderecoId;
        var sel = _enderecosSalvos.FirstOrDefault(a => a.Id == enderecoId);
        if (sel is not null)
        {
            PreencherEndereco(sel);
            await DefinirFreteParaEnderecoAsync(sel.Id);
        }
    }

    private async Task<string> GetUserIdAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            return user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
        }
        return string.Empty;
    }

    

    private async Task OnEnderecoSelecionadoMud(int? id)
    {
        if (!id.HasValue)
        {
            _enderecoSelecionadoId = null;
            _endereco = new EnderecoEntregaDto();
            StateHasChanged();
            return;
        }

        _enderecoSelecionadoId = id;
        var sel = _enderecosSalvos.FirstOrDefault(a => a.Id == id.Value);
        if (sel is not null)
        {
            PreencherEndereco(sel);
            await DefinirFreteParaEnderecoAsync(sel.Id);
        }
    }

    private void PreencherEndereco(AddressDto a)
    {
        _endereco.Rua = a.Rua;
        _endereco.Numero = a.Numero;
        _endereco.Cidade = a.Cidade;
        _endereco.Bairro = a.Bairro;
        _endereco.Complemento = a.Complemento;
        StateHasChanged();
    }

    private bool EnderecoSelecionado()
    {
        return !string.IsNullOrWhiteSpace(_endereco.Rua) &&
               !string.IsNullOrWhiteSpace(_endereco.Cidade) &&
               !string.IsNullOrWhiteSpace(_endereco.Bairro);
    }

    private string FormatEnderecoSelecionado()
    {
        var parts = new List<string> { _endereco.Rua };
        if (!string.IsNullOrWhiteSpace(_endereco.Numero))
        {
            parts.Add(_endereco.Numero);
        }
        parts.Add(_endereco.Bairro);
        parts.Add(_endereco.Cidade);
        if (!string.IsNullOrWhiteSpace(_endereco.Complemento))
        {
            parts.Add(_endereco.Complemento);
        }
        return string.Join(", ", parts);
    }

    private static string FormatEndereco(AddressDto a)
        => $"{a.Rua}, {a.Numero} - {a.Bairro}, {a.Cidade} {a.Complemento}";

    private static string TruncarEndereco(string texto, int maxLen = 33)
        => string.IsNullOrWhiteSpace(texto) || texto.Length <= maxLen
            ? texto
            : texto[..maxLen] + "...";

    private async Task DefinirFreteParaEnderecoAsync(int addressId)
    {
        // Tenta ler frete salvo do localStorage
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "shipping");
            var map = string.IsNullOrWhiteSpace(json)
                ? new Dictionary<int, decimal>()
                : System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, decimal>>(json) ?? new Dictionary<int, decimal>();

            if (map.TryGetValue(addressId, out var saved))
            {
                _frete = saved;
                StateHasChanged();
                return;
            }

            // Gera uma vez e persiste
            var rnd = new Random();
            var valor = rnd.NextDouble() * (20.0 - 10.0) + 10.0; // 10 a 20
            _frete = Math.Round((decimal)valor, 2);
            map[addressId] = _frete;
            var novoJson = System.Text.Json.JsonSerializer.Serialize(map);
            await JS.InvokeVoidAsync("localStorage.setItem", "shipping", novoJson);
            StateHasChanged();
        }
        catch
        {
            // fallback local
            var rnd = new Random();
            var valor = rnd.NextDouble() * (20.0 - 10.0) + 10.0;
            _frete = Math.Round((decimal)valor, 2);
        }
    }

    private string GerarCodigoPix()
    {
        var valor = (_total + _frete).ToString("F2").Replace(',', '.');
        var code = $"000201PIX-DEMOSMOKE|ORD={DateTime.UtcNow.Ticks}|VAL={valor}|CRC=ABCD";
        return code;
    }

    private string GerarBoleto()
    {
        var rnd = new Random();
        var sb = new System.Text.StringBuilder();
        for (int i = 0; i < 47; i++) sb.Append(rnd.Next(0, 10));
        return sb.ToString();
    }

    private string GerarQrSvgDataUri(string text)
    {
        // Placeholder simples: um SVG com o texto centralizado (não é um QR real)
        var safe = System.Net.WebUtility.HtmlEncode(text);
        var svg = $"<svg xmlns='http://www.w3.org/2000/svg' width='180' height='180'><rect width='100%' height='100%' fill='white'/><rect x='10' y='10' width='160' height='160' fill='none' stroke='#000'/><text x='90' y='95' font-size='10' text-anchor='middle' fill='#000'>{safe}</text></svg>";
        var uri = "data:image/svg+xml;utf8," + System.Net.WebUtility.UrlEncode(svg);
        return uri;
    }

    // Removido: bindings de campos manuais; checkout usa apenas endereços salvos

    private void AbrirPagamento()
    {
        _error = null;
        if (_itens.Count == 0)
        {
            _error = "Seu carrinho está vazio.";
            return;
        }

        // Validar se um endereço foi selecionado
        if (string.IsNullOrWhiteSpace(_endereco.Rua) ||
            string.IsNullOrWhiteSpace(_endereco.Cidade) ||
            string.IsNullOrWhiteSpace(_endereco.Bairro))
        {
            _error = "Por favor, selecione um endereço de entrega antes de finalizar o pedido.";
            return;
        }

        _showPagamento = true;
        _pagamentoMetodo = null;
        _pixCode = GerarCodigoPix();
        _boletoCodigo = GerarBoleto();
    }

    private async Task ConfirmarPagamentoAsync()
    {
        _error = null;
        _submitting = true;
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                _error = "Sessão expirada. Faça login para finalizar o pedido.";
                return;
            }

            // Validar novamente o endereço antes de criar o pedido
            if (string.IsNullOrWhiteSpace(_endereco.Rua) ||
                string.IsNullOrWhiteSpace(_endereco.Cidade) ||
                string.IsNullOrWhiteSpace(_endereco.Bairro))
            {
                _error = "Por favor, selecione um endereço de entrega antes de finalizar o pedido.";
                return;
            }

            var orderId = await OrderService.CriarPedidoAsync(userId, _itens, _endereco, _frete);
            await JS.InvokeVoidAsync("localStorage.removeItem", "cart");
            _showPagamento = false;
            Nav.NavigateTo($"/pedido/confirmacao/{orderId}");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _submitting = false;
        }
    }
}


