@page "/produtos"
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using SmokeExpress.Web.Models
@using SmokeExpress.Web.Services
@inject IProductService ProductService
@inject IReviewService ReviewService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Large" Class="mr-2" />
        Nossos Produtos
    </MudText>

    <!-- Painel de Filtros -->
    <div class="mb-4">
        <MudExpansionPanels MultiExpansion="false" Class="mb-2">
                <MudExpansionPanel Text="Filtros de Busca" Icon="@Icons.Material.Filled.FilterList" isExpanded="@_filtrosExpandidos">
                    <MudGrid Spacing="3">
                        <!-- Faixa de Preço -->
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="_filtros.PrecoMin" 
                                            Label="Preço Mínimo" 
                                            variant="Variant.Outlined"
                                             Margin="Margin.Dense"
                                             Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                            Min="0"
                                            Format="C"
                                            HelperText="Deixe em branco para sem limite" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="_filtros.PrecoMax" 
                                            Label="Preço Máximo" 
                                            variant="Variant.Outlined"
                                             Margin="Margin.Dense"
                                             Dense="true"
                                            Adornment="Adornment.Start"
                                            AdornmentIcon="@Icons.Material.Filled.AttachMoney"
                                            Min="0"
                                            Format="C"
                                            HelperText="Deixe em branco para sem limite" />
                        </MudItem>

                        <!-- Estoque e Ordenação -->
                        <MudItem xs="12" md="6">
                            <MudSwitch @bind-Value="_apenasEmEstoque" 
                                     Label="Apenas produtos em estoque" 
                                     Color="Color.Success"
                                     Class="mt-4" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudSelect @bind-Value="_filtros.Ordenacao" 
                                     Label="Ordenar por" 
                                     variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Dense="true"
                                     T="ProductSortOrder">
                                <MudSelectItem Value="@ProductSortOrder.Nome">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.SortByAlpha" Size="Size.Small" />
                                        <span>Nome (A-Z)</span>
                                    </MudStack>
                                </MudSelectItem>
                                <MudSelectItem Value="@ProductSortOrder.PrecoAsc">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" Size="Size.Small" />
                                        <span>Preço: Menor para Maior</span>
                                    </MudStack>
                                </MudSelectItem>
                                <MudSelectItem Value="@ProductSortOrder.PrecoDesc">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" Size="Size.Small" />
                                        <span>Preço: Maior para Menor</span>
                                    </MudStack>
                                </MudSelectItem>
                                <MudSelectItem Value="@ProductSortOrder.Relevancia">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" />
                                        <span>Relevância</span>
                                    </MudStack>
                                </MudSelectItem>
                                <MudSelectItem Value="@ProductSortOrder.MelhoresAvaliados">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" />
                                        <span>Melhores Avaliados</span>
                                    </MudStack>
                                </MudSelectItem>
                            </MudSelect>
                        </MudItem>

                        <!-- Botões de Ação -->
                        <MudItem xs="12">
                            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                                <MudButton variant="Variant.Outlined" 
                                          Color="Color.Default"
                                          StartIcon="@Icons.Material.Filled.Clear"
                                          onClick="LimparFiltros"
                                          Disabled="@(!TemFiltrosAtivos())">
                                    Limpar Filtros
                                </MudButton>
                                <MudButton variant="Variant.Filled" 
                                          Color="Color.Primary"
                                          StartIcon="@Icons.Material.Filled.Search"
                                          onClick="AplicarFiltros">
                                    Aplicar Filtros
                                </MudButton>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <!-- Chips de Filtros Ativos -->
            @if (TemFiltrosAtivos())
            {
                <MudDivider Class="my-3" />
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Filtros ativos:</MudText>
                    @if (!string.IsNullOrWhiteSpace(_filtros.TermoBusca))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" onClose="@(() => { _filtros.TermoBusca = null; AplicarFiltros(); })">
                            Busca: @_filtros.TermoBusca
                        </MudChip>
                    }
                    @if (_filtros.CategoriaId.HasValue)
                    {
                        string? categoriaNome = null;

                        var categoria = _categorias.FirstOrDefault(c => c.Id == _filtros.CategoriaId.Value);
                        if (categoria is not null)
                        {
                            categoriaNome = categoria.Nome;
                        }
                        else if (_resultado?.Items is not null)
                        {
                            var produtoComCategoria = _resultado.Items
                                .FirstOrDefault(p => p.CategoriaId == _filtros.CategoriaId.Value
                                                     || (p.Categoria != null && p.Categoria.Id == _filtros.CategoriaId.Value));
                            categoriaNome = produtoComCategoria?.Categoria?.Nome;
                        }

                        if (!string.IsNullOrWhiteSpace(categoriaNome))
                        {
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary" onClose="@(() => { _filtros.CategoriaId = null; AplicarFiltros(); })">
                                Categoria: @categoriaNome
                        </MudChip>
                        }
                    }
                    @if (_filtros.PrecoMin.HasValue)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" onClose="@(() => { _filtros.PrecoMin = null; AplicarFiltros(); })">
                            Min: @_filtros.PrecoMin.Value.ToString("C")
                        </MudChip>
                    }
                    @if (_filtros.PrecoMax.HasValue)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" onClose="@(() => { _filtros.PrecoMax = null; AplicarFiltros(); })">
                            Max: @_filtros.PrecoMax.Value.ToString("C")
                        </MudChip>
                    }
                    @if (_apenasEmEstoque == true)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" onClose="@(() => { _apenasEmEstoque = false; AplicarFiltros(); })">
                            Em Estoque
                        </MudChip>
                    }
                </MudStack>
            }
    </div>

    <!-- Mensagens de Erro e Loading -->
    @if (!string.IsNullOrEmpty(_mensagemErro))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" dismissible="true" onClose="@(() => _mensagemErro = null)">
            <MudText Typo="Typo.body1">@_mensagemErro</MudText>
        </MudAlert>
    }
    else if (_carregando)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        <MudText Typo="Typo.body1" Class="text-center">Carregando produtos...</MudText>
    }
    else if (_resultado?.Items.Count == 0)
    {
        <MudPaper Elevation="1" Class="pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Large" Color="Color.Default" Class="mb-4" />
            <MudText Typo="Typo.h6" Class="mb-2">
                @if (TemFiltrosAtivos())
                {
                    <span>Nenhum produto encontrado com os filtros aplicados.</span>
                }
                else
                {
                    <span>Nenhum produto disponível no momento.</span>
                }
            </MudText>
            @if (TemFiltrosAtivos())
            {
                <MudButton variant="Variant.Outlined" Color="Color.Primary" onClick="LimparFiltros" Class="mt-4">
                    Limpar Filtros
                </MudButton>
            }
        </MudPaper>
    }
    else if (_resultado != null)
    {
        <!-- Grid de Produtos -->
        <MudGrid Spacing="3">
            @foreach (var produto in _resultado.Items)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <ProductCard Produto="produto"
                                 MediaAvaliacao="@(_mediasAvaliacoes.TryGetValue(produto.Id, out var media) ? media : null)"
                                 ResumoDescricao="@ObterResumo(produto.Descricao)"
                                 DescricaoStyle="height: 72px; overflow: hidden;" />
                </MudItem>
            }
        </MudGrid>

        <!-- Paginação -->
        @if (_resultado.TotalPages > 1)
        {
            <MudStack Spacing="2" AlignItems="AlignItems.Center" Class="mt-4">
                <MudPagination Color="Color.Primary"
                               Count="@_resultado.TotalPages"
                               Selected="@PageNumber"
                               SelectedChanged="@OnPageChanged"
                               ShowFirstButton="true"
                               ShowLastButton="true" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Exibindo @((_resultado.PageNumber - 1) * _pageSize + 1) até @Math.Min(_resultado.PageNumber * _pageSize, _resultado.TotalCount) de @_resultado.TotalCount produtos
                </MudText>
            </MudStack>
        }
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery(Name = "search")]
    public string? SearchQuery { get; set; }

    [SupplyParameterFromQuery(Name = "categoria")]
    public int? CategoriaQuery { get; set; }

    [SupplyParameterFromQuery(Name = "precoMin")]
    public decimal? PrecoMinQuery { get; set; }

    [SupplyParameterFromQuery(Name = "precoMax")]
    public decimal? PrecoMaxQuery { get; set; }

    [SupplyParameterFromQuery(Name = "estoque")]
    public bool? EstoqueQuery { get; set; }

    [SupplyParameterFromQuery(Name = "ordenacao")]
    public string? OrdenacaoQuery { get; set; }

    [SupplyParameterFromQuery(Name = "page")]
    public int? PageQuery { get; set; }

    private ProductSearchFilters _filtros = new();
    private bool _apenasEmEstoque = false;
    private bool _filtrosExpandidos = false;
    private PagedResult<Product>? _resultado;
    private IReadOnlyList<Category> _categorias = Array.Empty<Category>();
    private bool _carregando = true;
    private string? _mensagemErro;
    private const int _pageSize = 16;
    private Dictionary<int, decimal?> _mediasAvaliacoes = new();

    private int PageNumber => PageQuery ?? 1;

    protected override async Task OnInitializedAsync()
    {
        await CarregarCategoriasAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Carregar filtros da query string
        _filtros.TermoBusca = SearchQuery;
        _filtros.CategoriaId = CategoriaQuery;
        _filtros.PrecoMin = PrecoMinQuery;
        _filtros.PrecoMax = PrecoMaxQuery;
        _apenasEmEstoque = EstoqueQuery ?? false;
        
        // Fazer parsing manual do enum da query string
        if (!string.IsNullOrWhiteSpace(OrdenacaoQuery))
        {
            if (int.TryParse(OrdenacaoQuery, out var ordenacaoInt) && Enum.IsDefined(typeof(ProductSortOrder), ordenacaoInt))
            {
                _filtros.Ordenacao = (ProductSortOrder)ordenacaoInt;
            }
            else if (Enum.TryParse<ProductSortOrder>(OrdenacaoQuery, ignoreCase: true, out var ordenacaoEnum))
            {
                _filtros.Ordenacao = ordenacaoEnum;
            }
            else
            {
                _filtros.Ordenacao = ProductSortOrder.Nome;
            }
        }
        else
        {
            _filtros.Ordenacao = ProductSortOrder.Nome;
        }

        // Expandir filtros se houver algum ativo
        _filtrosExpandidos = TemFiltrosAtivos();

            await CarregarProdutosAsync();
    }

    private async Task CarregarCategoriasAsync()
    {
        try
        {
            _categorias = await DbContext.Categories
                .AsNoTracking()
                .OrderBy(c => c.Nome)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _mensagemErro = $"Erro ao carregar categorias: {ex.Message}";
        }
    }

    private async Task CarregarProdutosAsync()
    {
        _carregando = true;
        _mensagemErro = null;

        try
        {
            var pageNumber = PageNumber;
            if (pageNumber < 1) pageNumber = 1;

            // Aplicar filtro de estoque
            _filtros.ApenasEmEstoque = _apenasEmEstoque ? true : null;

            _resultado = await ProductService.BuscarPaginadoAsync(
                _filtros,
                pageNumber,
                _pageSize);

            // Carregar médias de avaliações para os produtos
            if (_resultado != null && _resultado.Items.Any())
            {
                await CarregarMediasAvaliacoesAsync();
            }
        }
        catch (Exception ex)
        {
            _mensagemErro = $"Erro ao carregar os produtos: {ex.Message}";
        }
        finally
        {
            _carregando = false;
            StateHasChanged();
        }
    }

    private async Task CarregarMediasAvaliacoesAsync()
    {
        if (_resultado == null || !_resultado.Items.Any()) return;

        var productIds = _resultado.Items.Select(p => p.Id).ToList();
        _mediasAvaliacoes = await ReviewService.ObterMediasAvaliacoesPorProdutosAsync(productIds);
    }

    private void AplicarFiltros()
    {
        Navigation.NavigateTo(ObterUrlComFiltros());
    }

    private void LimparFiltros()
    {
        _filtros = new ProductSearchFilters();
        _apenasEmEstoque = false;
        Navigation.NavigateTo("/produtos");
    }

    private void HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AplicarFiltros();
        }
    }

    private void OnPageChanged(int page)
    {
        var queryParams = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(_filtros.TermoBusca))
        {
            queryParams.Add($"search={Uri.EscapeDataString(_filtros.TermoBusca)}");
        }
        
        if (_filtros.CategoriaId.HasValue)
        {
            queryParams.Add($"categoria={_filtros.CategoriaId.Value}");
        }

        if (_filtros.PrecoMin.HasValue)
        {
            queryParams.Add($"precoMin={_filtros.PrecoMin.Value}");
        }

        if (_filtros.PrecoMax.HasValue)
        {
            queryParams.Add($"precoMax={_filtros.PrecoMax.Value}");
        }

        if (_apenasEmEstoque)
        {
            queryParams.Add($"estoque=true");
        }

        if (_filtros.Ordenacao != ProductSortOrder.Nome)
        {
            queryParams.Add($"ordenacao={(int)_filtros.Ordenacao}");
        }
        
        if (page > 1)
        {
            queryParams.Add($"page={page}");
        }

        var query = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
        Navigation.NavigateTo($"/produtos{query}");
    }

    private string ObterUrlComFiltros()
    {
        var queryParams = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(_filtros.TermoBusca))
        {
            queryParams.Add($"search={Uri.EscapeDataString(_filtros.TermoBusca)}");
        }
        
        if (_filtros.CategoriaId.HasValue)
        {
            queryParams.Add($"categoria={_filtros.CategoriaId.Value}");
        }

        if (_filtros.PrecoMin.HasValue)
        {
            queryParams.Add($"precoMin={_filtros.PrecoMin.Value}");
        }

        if (_filtros.PrecoMax.HasValue)
        {
            queryParams.Add($"precoMax={_filtros.PrecoMax.Value}");
        }

        if (_apenasEmEstoque)
        {
            queryParams.Add($"estoque=true");
        }

        if (_filtros.Ordenacao != ProductSortOrder.Nome)
        {
            queryParams.Add($"ordenacao={(int)_filtros.Ordenacao}");
        }

        var query = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
        return $"/produtos{query}";
    }

    private bool TemFiltrosAtivos()
    {
        return !string.IsNullOrWhiteSpace(_filtros.TermoBusca) ||
               _filtros.CategoriaId.HasValue ||
               _filtros.PrecoMin.HasValue ||
               _filtros.PrecoMax.HasValue ||
               _apenasEmEstoque ||
               _filtros.Ordenacao != ProductSortOrder.Nome;
    }

    private static string ObterResumo(string? descricao)
    {
        if (string.IsNullOrWhiteSpace(descricao))
        {
            return "Produto premium da Smoke Express.";
        }

        var textoPlano = descricao.Replace("<", " ").Replace(">", " ");
        return textoPlano.Length > 150
            ? textoPlano[..150] + "..."
            : textoPlano;
    }
}
