@page "/produtos/{Id:int}"
@using MudBlazor
@using SmokeExpress.Web.Models
@inject IProductService ProductService
@inject IReviewService ReviewService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (_carregando)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        <MudText Typo="Typo.body1" Class="text-center">Carregando produto...</MudText>
    }
    else if (_produto == null)
    {
        <MudPaper Elevation="2" Class="pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
            <MudText Typo="Typo.h5" Class="mb-3">Produto não encontrado</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                O produto solicitado não foi encontrado ou não está mais disponível.
            </MudText>
            <MudButton variant="Variant.Filled" 
                      Color="Color.Primary" 
                      Href="/produtos"
                      StartIcon="@Icons.Material.Filled.Store">
                Voltar para catálogo
            </MudButton>
        </MudPaper>
    }
    else
    {
        <!-- Breadcrumb -->
        <MudBreadcrumbs Items="@_breadcrumbItems" Class="mb-4" />

        <MudGrid Spacing="4">
            <!-- Imagem do Produto -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Style="overflow: hidden; padding: 0;">
                    @if (!string.IsNullOrWhiteSpace(_produto.ImagemUrl))
                    {
                        <div style="width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #f5f5f5; padding: 2rem;">
                            <img src="@_produto.ImagemUrl" 
                                 alt="@_produto.Nome" 
                                 style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                        </div>
                    }
                    else
                    {
                        <div style="width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
                            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" Color="Color.Default" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Sem imagem disponível</MudText>
                            </MudStack>
                        </div>
                    }
                </MudCard>
            </MudItem>

            <!-- Informações do Produto -->
            <MudItem xs="12" md="6">
                <MudStack Spacing="3">
                    <!-- Nome e Categoria -->
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h3" Class="mb-0">@_produto.Nome</MudText>
                        <MudChip T="string" 
                               Size="Size.Medium" 
                               Color="Color.Secondary" 
                               variant="Variant.Outlined"
                               Icon="@Icons.Material.Filled.Category">
                            @_produto.Categoria?.Nome
                        </MudChip>
                    </MudStack>

                    <MudDivider />

                    <!-- Preço e Estoque -->
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h4" Color="Color.Primary" Class="font-weight-bold">
                            @_produto.Preco.ToString("C")
                        </MudText>
                        @if (_produto.Estoque > 0)
                        {
                            <MudChip T="string" 
                                   Size="Size.Medium" 
                                   Color="Color.Success" 
                                   variant="Variant.Filled"
                                   Icon="@Icons.Material.Filled.CheckCircle">
                                Em estoque - @_produto.Estoque unidades disponíveis
                            </MudChip>
                        }
                        else
                        {
                            <MudChip T="string" 
                                   Size="Size.Medium" 
                                   Color="Color.Error" 
                                   variant="Variant.Filled"
                                   Icon="@Icons.Material.Filled.Cancel">
                                Sem estoque no momento
                            </MudChip>
                        }
                    </MudStack>

                    <MudDivider />

                    <!-- Descrição -->
                    <MudCard Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-2" />
                            Descrição
                        </MudText>
                        @if (!string.IsNullOrWhiteSpace(_produto.Descricao))
                        {
                            <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_produto.Descricao</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body1" Color="Color.Secondary">
                                Produto premium da Smoke Express com qualidade garantida.
                            </MudText>
                        }
                    </MudCard>

                    <!-- Quantidade e Ações -->
                    <MudCard Elevation="1" Class="pa-4">
                        <MudStack Spacing="3">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                <MudText Typo="Typo.body1" Class="mb-0">Quantidade:</MudText>
                                <MudNumericField @bind-Value="_quantidadeSelecionada" 
                                               Min="1" 
                                               Max="@(_produto.Estoque > 0 ? _produto.Estoque : 1)"
                                               variant="Variant.Outlined"
                                               Style="max-width: 150px;" />
                            </MudStack>

                            @if (!string.IsNullOrWhiteSpace(_feedback))
                            {
                                <MudAlert Severity="Severity.Success" dismissible="true" onClose="@(() => _feedback = null)">
                                    <MudText Typo="Typo.body2">@_feedback</MudText>
                                </MudAlert>
                            }

                            @if (!string.IsNullOrEmpty(_mensagemErro))
                            {
                                <MudAlert Severity="Severity.Error" dismissible="true" onClose="@(() => _mensagemErro = null)">
                                    <MudText Typo="Typo.body2">@_mensagemErro</MudText>
                                </MudAlert>
                            }

                            <MudStack Row="true" Spacing="2">
                                @if (_produto.Estoque > 0)
                                {
                                    <MudButton variant="Variant.Filled" 
                                             Color="Color.Primary" 
                                             Size="Size.Large"
                                             StartIcon="@Icons.Material.Filled.ShoppingCart"
                                             onClick="AdicionarAoCarrinhoAsync"
                                             Disabled="@_adicionando"
                                             FullWidth="true"
                                             Class="flex-fill">
                                        @(_adicionando ? "Adicionando..." : "Adicionar ao Carrinho")
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton variant="Variant.Filled" 
                                             Color="Color.Default" 
                                             Size="Size.Large"
                                             StartIcon="@Icons.Material.Filled.RemoveShoppingCart"
                                             Disabled="true"
                                             FullWidth="true"
                                             Class="flex-fill">
                                        Produto sem estoque
                                    </MudButton>
                                }
                                <MudButton variant="Variant.Outlined" 
                                         Color="Color.Secondary" 
                                         Size="Size.Large"
                                         StartIcon="@Icons.Material.Filled.ArrowBack"
                                         Href="/produtos"
                                         FullWidth="false">
                                    Voltar
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudCard>

                    <!-- Informações Adicionais -->
                    <MudCard Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" Class="mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                            Informações do Produto
                        </MudText>
                        <MudStack Spacing="2">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Color="Color.Secondary" />
                                <MudText Typo="Typo.body2">
                                    <strong>Categoria:</strong> @_produto.Categoria?.Nome
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Color="Color.Secondary" />
                                <MudText Typo="Typo.body2">
                                    <strong>Estoque:</strong> @_produto.Estoque unidades
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Color="Color.Secondary" />
                                <MudText Typo="Typo.body2">
                                    <strong>Preço:</strong> @_produto.Preco.ToString("C")
                                </MudText>
                            </MudStack>
                        </MudStack>
                    </MudCard>
                </MudStack>
            </MudItem>
        </MudGrid>

        <!-- Seção de Avaliações -->
        @if (_produto != null)
        {
            <MudDivider Class="my-6" />
            <MudGrid>
                <MudItem xs="12">
                <MudCard Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Medium" Class="mr-2" />
                        Avaliações
                    </MudText>

                    @if (_carregandoAvaliacoes)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                        <MudText Typo="Typo.body2" Class="text-center">Carregando avaliações...</MudText>
                    }
                    else
                    {
                        <!-- Média de Avaliações -->
                        @if (_mediaAvaliacoes.HasValue)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-4">
                                <RatingDisplay Rating="@_mediaAvaliacoes" StarSize="1.875rem" />
                                <MudText Typo="Typo.h6" Class="mb-0">
                                    @_mediaAvaliacoes.Value.ToString("F1")
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-0">
                                    (@_totalAvaliacoes @(_totalAvaliacoes == 1 ? "avaliação" : "avaliações"))
                                </MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                                Ainda não há avaliações para este produto.
                            </MudText>
                        }

                        <!-- Lista de Avaliações com Comentário -->
                        @if (_avaliacoesComComentario.Count > 0)
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6" Class="mb-3">Comentários dos Clientes</MudText>
                            
                            @foreach (var avaliacao in _avaliacoesComComentarioPaginadas)
                            {
                                <MudCard Elevation="1" Class="pa-4 mb-3">
                                    <MudStack Spacing="2">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                    @(avaliacao.ApplicationUser?.NomeCompleto?.Substring(0, 1).ToUpper() ?? "U")
                                                </MudAvatar>
                                                <MudText Typo="Typo.body1" Class="font-weight-bold mb-0">
                                                    @(avaliacao.ApplicationUser?.NomeCompleto ?? "Usuário Anônimo")
                                                </MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @avaliacao.DataAvaliacao.ToLocalTime().ToString("dd/MM/yyyy")
                                            </MudText>
                                        </MudStack>
                                        <RatingDisplay IntegerRating="@avaliacao.Rating" StarSize="1.25rem" />
                                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                                            @avaliacao.Comment
                                        </MudText>
                                    </MudStack>
                                </MudCard>
                            }

                            @if (_totalAvaliacoesComComentario > 5)
                            {
                                <MudPagination Count="@_totalPaginas" 
                                             Selected="@(_paginaAtual + 1)" 
                                             SelectedChanged="@OnPageChanged"
                                             Class="mt-4" />
                            }
                        }
                        else if (_mediaAvaliacoes.HasValue)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">
                                Ainda não há avaliações com comentários para este produto.
                            </MudText>
                        }
                    }
                </MudCard>
                </MudItem>
            </MudGrid>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public int Id { get; set; }

    private Product? _produto;
    private bool _carregando = true;
    private string? _mensagemErro;
    private string? _feedback;
    private int _quantidadeSelecionada = 1;
    private bool _adicionando = false;
    private IReadOnlyList<BreadcrumbItem> _breadcrumbItems = Array.Empty<BreadcrumbItem>();
    
    // Avaliações
    private bool _carregandoAvaliacoes = false;
    private decimal? _mediaAvaliacoes;
    private int _totalAvaliacoes = 0;
    private IReadOnlyList<ProductReview> _avaliacoesComComentario = Array.Empty<ProductReview>();
    private int _paginaAtual = 0;
    private const int _avaliacoesPorPagina = 5;

    protected override async Task OnInitializedAsync()
    {
        await CarregarProdutoAsync();
        await CarregarAvaliacoesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await CarregarProdutoAsync();
        await CarregarAvaliacoesAsync();
    }

    private async Task CarregarProdutoAsync()
    {
        _carregando = true;
        _mensagemErro = null;
        _feedback = null;

        try
        {
            _produto = await ProductService.ObterPorIdAsync(Id);
            
            if (_produto != null)
            {
                _breadcrumbItems = new List<BreadcrumbItem>
                {
                    new BreadcrumbItem("Home", "/", icon: Icons.Material.Filled.Home),
                    new BreadcrumbItem("Produtos", "/produtos", icon: Icons.Material.Filled.Store),
                    new BreadcrumbItem(_produto.Nome, href: null, disabled: true)
                };
            }
        }
        catch (Exception ex)
        {
            _mensagemErro = $"Erro ao carregar o produto: {ex.Message}";
        }
        finally
        {
            _carregando = false;
        }
    }

    private async Task CarregarAvaliacoesAsync()
    {
        if (_produto == null) return;

        _carregandoAvaliacoes = true;
        try
        {
            var resumo = await ReviewService.ObterResumoAvaliacoesAsync(_produto.Id);
            _mediaAvaliacoes = resumo.Media;
            _totalAvaliacoes = resumo.Total;
            _avaliacoesComComentario = resumo.AvaliacoesComComentario.ToList();
            _paginaAtual = 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar avaliações: {ex.Message}", Severity.Error);
        }
        finally
        {
            _carregandoAvaliacoes = false;
            StateHasChanged();
        }
    }

    private void OnPageChanged(int page)
    {
        _paginaAtual = page - 1;
        StateHasChanged();
    }

    private List<ProductReview> _avaliacoesComComentarioPaginadas => _avaliacoesComComentario
        .Skip(_paginaAtual * _avaliacoesPorPagina)
        .Take(_avaliacoesPorPagina)
        .ToList();

    private int _totalPaginas => (int)Math.Ceiling((double)_totalAvaliacoesComComentario / _avaliacoesPorPagina);

    private int _totalAvaliacoesComComentario => _avaliacoesComComentario.Count;

    private async Task AdicionarAoCarrinhoAsync()
    {
        if (_produto is null)
        {
            return;
        }

        _adicionando = true;
        _mensagemErro = null;
        _feedback = null;

        try
        {
            if (_quantidadeSelecionada < 1)
            {
                _quantidadeSelecionada = 1;
            }

            if (_quantidadeSelecionada > _produto.Estoque)
            {
                _mensagemErro = $"Quantidade solicitada ({_quantidadeSelecionada}) excede o estoque disponível ({_produto.Estoque}).";
                return;
            }

            var json = await JS.InvokeAsync<string>("localStorage.getItem", "cart");
            var itens = string.IsNullOrWhiteSpace(json)
                ? new List<ClientCartItem>()
                : System.Text.Json.JsonSerializer.Deserialize<List<ClientCartItem>>(json) ?? new List<ClientCartItem>();

            var existente = itens.FirstOrDefault(i => i.ProductId == _produto.Id);
            if (existente is null)
            {
                itens.Add(new ClientCartItem
                {
                    ProductId = _produto.Id,
                    Quantidade = _quantidadeSelecionada,
                    Nome = _produto.Nome,
                    PrecoUnitario = _produto.Preco,
                    ImagemUrl = _produto.ImagemUrl
                });
            }
            else
            {
                var novaQuantidade = existente.Quantidade + _quantidadeSelecionada;
                if (novaQuantidade > _produto.Estoque)
                {
                    _mensagemErro = $"A quantidade total no carrinho ({novaQuantidade}) excede o estoque disponível ({_produto.Estoque}).";
                    return;
                }
                existente.Quantidade = novaQuantidade;
                existente.Nome = _produto.Nome;
                existente.PrecoUnitario = _produto.Preco;
                existente.ImagemUrl = _produto.ImagemUrl;
            }

            var novoJson = System.Text.Json.JsonSerializer.Serialize(itens);
            await JS.InvokeVoidAsync("localStorage.setItem", "cart", novoJson);
            _feedback = $"Produto adicionado ao carrinho! ({_quantidadeSelecionada} unidade(s))";
            Snackbar.Add(_feedback, Severity.Success);
            _quantidadeSelecionada = 1; // Reset para 1 após adicionar
        }
        catch (Exception ex)
        {
            _mensagemErro = $"Erro ao adicionar ao carrinho: {ex.Message}";
            Snackbar.Add(_mensagemErro, Severity.Error);
        }
        finally
        {
            _adicionando = false;
            StateHasChanged();
        }
    }

    private sealed class ClientCartItem
    {
        public int ProductId { get; set; }
        public int Quantidade { get; set; }
        public string? Nome { get; set; }
        public decimal PrecoUnitario { get; set; }
        public string? ImagemUrl { get; set; }
    }
}
