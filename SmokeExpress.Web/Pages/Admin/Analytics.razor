@page "/admin/estatisticas"
@attribute [Authorize(Roles = "Admin")]
@using MudBlazor
@using SmokeExpress.Web.Exceptions
@using SmokeExpress.Web.Models
@using SmokeExpress.Web.Models.Dashboard
@using SmokeExpress.Web.Services
@inject IAnalyticsService AnalyticsService
@inject NavigationManager Navigation

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Analytics" Size="Size.Large" Class="mr-2" />
        Estatísticas e Relatórios
    </MudText>

    <!-- Filtros de Período -->
    <MudCard Elevation="2" Class="mb-4">
        <MudCardContent>
            <MudGrid Spacing="3">
                <MudItem xs="12" md="4">
                    <MudSelect @bind-Value="_periodoFiltro" 
                               Label="Período" 
                               variant="Variant.Outlined"
                               T="PeriodFilter">
                        <MudSelectItem Value="@PeriodFilter.Hoje">Hoje</MudSelectItem>
                        <MudSelectItem Value="@PeriodFilter.EstaSemana">Esta Semana</MudSelectItem>
                        <MudSelectItem Value="@PeriodFilter.EsteMes">Este Mês</MudSelectItem>
                        <MudSelectItem Value="@PeriodFilter.EsteAno">Este Ano</MudSelectItem>
                        <MudSelectItem Value="@PeriodFilter.Personalizado">Personalizado</MudSelectItem>
                    </MudSelect>
                </MudItem>
                @if (_periodoFiltro == PeriodFilter.Personalizado)
                {
                    <MudItem xs="12" md="4">
                        <MudDatePicker @bind-Date="_dataInicio" 
                                      Label="Data Início" 
                                      variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudDatePicker @bind-Date="_dataFim" 
                                      Label="Data Fim" 
                                      variant="Variant.Outlined" />
                    </MudItem>
                }
                <MudItem xs="12" md="4">
                    <MudSelect @bind-Value="_topItems" 
                               Label="Quantidade de Itens" 
                               variant="Variant.Outlined"
                               T="int">
                        <MudSelectItem Value="5">Top 5</MudSelectItem>
                        <MudSelectItem Value="10">Top 10</MudSelectItem>
                        <MudSelectItem Value="20">Top 20</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudButton variant="Variant.Filled" 
                              Color="Color.Primary" 
                              FullWidth="true"
                              StartIcon="@Icons.Material.Filled.Refresh"
                              onClick="CarregarDadosAsync"
                              Disabled="@_carregando"
                              Class="mt-4">
                        @(_carregando ? "Carregando..." : "Atualizar Dados")
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    @if (_carregando)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        <MudText Typo="Typo.body1" Class="text-center">Carregando estatísticas...</MudText>
    }
    else
    {
        @if (_tipoMensagem != TipoMensagem.Nenhuma && !string.IsNullOrEmpty(_mensagem))
        {
            <MudAlert Severity="@ObterSeveridadeMensagem(_tipoMensagem)" 
                      Class="mb-4" 
                      Dense="false"
                      Icon="@ObterIconeMensagem(_tipoMensagem)">
                @_mensagem
            </MudAlert>
        }

        @if (_tipoMensagem != TipoMensagem.Critico && _tipoMensagem != TipoMensagem.Validacao)
        {
        <!-- KPIs Principais -->
        <MudGrid Spacing="3" Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Receita Total</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">@_resumo.ReceitaTotal.ToString("C")</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" Size="Size.Medium" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total de Pedidos</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">@_resumo.TotalPedidos</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Primary" Size="Size.Medium" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Média por Pedido</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Info">@_resumo.MediaValorPedido.ToString("C")</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Calculate" Color="Color.Info" Size="Size.Medium" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Clientes Ativos</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Warning">@_resumo.TotalClientesAtivos</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Warning" Size="Size.Medium" />
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Visualização de Vendas por Período -->
        @if (_vendasPorPeriodo.Any())
        {
            <MudCard Elevation="2" Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-4">Vendas por Período - Visualização</MudText>
                    <MudGrid Spacing="2">
                        @foreach (var venda in _vendasPorPeriodo)
                        {
                            var maxReceita = _vendasPorPeriodo.Max(v => v.Receita);
                            var porcentagem = maxReceita > 0 ? (venda.Receita / maxReceita) * 100 : 0;
                            <MudItem xs="12">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.body1" Class="font-weight-bold">@venda.Periodo</MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Success">@venda.Receita.ToString("C")</MudText>
                                    </MudStack>
                                    <MudProgressLinear Color="Color.Success" Value="@((double)porcentagem)" variant="Variant.Filled" Class="mb-2" />
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @venda.QuantidadePedidos pedido(s) • @venda.QuantidadeItensVendidos item(ns)
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                                <MudDivider Class="my-2" />
                            </MudItem>
                        }
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        }

        <!-- Tabela de Vendas por Período -->
        @if (_vendasPorPeriodo.Any())
        {
            <MudCard Elevation="2" Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-4">Detalhamento de Vendas</MudText>
                    <MudTable Items="@_vendasPorPeriodo" Hover="true" Dense="true">
                        <HeaderContent>
                            <MudTh>Período</MudTh>
                            <MudTh align="Align.Right">Receita</MudTh>
                            <MudTh align="Align.Right">Pedidos</MudTh>
                            <MudTh align="Align.Right">Itens Vendidos</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Período">@context.Periodo</MudTd>
                            <MudTd DataLabel="Receita" align="Align.Right">@context.Receita.ToString("C")</MudTd>
                            <MudTd DataLabel="Pedidos" align="Align.Right">@context.QuantidadePedidos</MudTd>
                            <MudTd DataLabel="Itens Vendidos" align="Align.Right">@context.QuantidadeItensVendidos</MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        }

        <MudGrid Spacing="3">
            <!-- Pedidos por Status -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-4">Pedidos por Status</MudText>
                        @if (_pedidosPorStatus.Any())
                        {
                            <MudSimpleTable Dense="true">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th style="text-align: right;">Quantidade</th>
                                        <th style="text-align: right;">Receita</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var status in _pedidosPorStatus)
                                    {
                                        <tr>
                                            <td>
                                                <MudChip T="string" Size="Size.Small" Color="@ObterCorStatus(status.Status)">
                                                    @status.StatusTexto
                                                </MudChip>
                                            </td>
                                            <td style="text-align: right;">@status.Quantidade</td>
                                            <td style="text-align: right;">@status.TotalReceita.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                                Nenhum pedido encontrado.
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Produtos com Menor Estoque -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-4">Produtos com Menor Estoque</MudText>
                        @if (_produtosMenorEstoque.Any())
                        {
                            <MudTable Items="@_produtosMenorEstoque" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Produto</MudTh>
                                    <MudTh align="Align.Right">Estoque</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Produto">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            @if (!string.IsNullOrEmpty(context.ImagemUrl))
                                            {
                                                <MudAvatar Size="Size.Small" Style="width: 40px; height: 40px;">
                                                    <img src="@context.ImagemUrl" alt="@context.Nome" style="width: 100%; height: 100%; object-fit: cover;" />
                                                </MudAvatar>
                                            }
                                            <MudText Typo="Typo.body2">@context.Nome</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Estoque" align="Align.Right">
                                        <MudChip T="string" Size="Size.Small" Color="@(context.Estoque <= 5 ? Color.Error : context.Estoque <= 10 ? Color.Warning : Color.Success)">
                                            @context.Estoque
                                        </MudChip>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                                Nenhum produto encontrado.
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Produtos Mais Vendidos -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-4">Produtos Mais Vendidos</MudText>
                        @if (_produtosMaisVendidos.Any())
                        {
                            <MudTable Items="@_produtosMaisVendidos" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Produto</MudTh>
                                    <MudTh align="Align.Right">Quantidade</MudTh>
                                    <MudTh align="Align.Right">Receita</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Produto">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            @if (!string.IsNullOrEmpty(context.ImagemUrl))
                                            {
                                                <MudAvatar Size="Size.Small" Style="width: 40px; height: 40px;">
                                                    <img src="@context.ImagemUrl" alt="@context.Nome" style="width: 100%; height: 100%; object-fit: cover;" />
                                                </MudAvatar>
                                            }
                                            <MudText Typo="Typo.body2">@context.Nome</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Quantidade" align="Align.Right">@context.QuantidadeVendida</MudTd>
                                    <MudTd DataLabel="Receita" align="Align.Right">@context.Receita.ToString("C")</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                                Nenhuma venda encontrada.
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Produtos Melhores Avaliados -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-4">Produtos Melhores Avaliados</MudText>
                        @if (_produtosMelhoresAvaliados.Any())
                        {
                            <MudTable Items="@_produtosMelhoresAvaliados" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Produto</MudTh>
                                    <MudTh align="Align.Center">Avaliação</MudTh>
                                    <MudTh align="Align.Right">Total</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Produto">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            @if (!string.IsNullOrEmpty(context.ImagemUrl))
                                            {
                                                <MudAvatar Size="Size.Small" Style="width: 40px; height: 40px;">
                                                    <img src="@context.ImagemUrl" alt="@context.Nome" style="width: 100%; height: 100%; object-fit: cover;" />
                                                </MudAvatar>
                                            }
                                            <MudText Typo="Typo.body2">@context.Nome</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Avaliação" align="Align.Center">
                                        <RatingDisplay Rating="@context.MediaAvaliacao" StarSize="0.875rem" />
                                    </MudTd>
                                    <MudTd DataLabel="Total" align="Align.Right">@context.TotalAvaliacoes</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                                Nenhuma avaliação encontrada.
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Produtos Piores Avaliados -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-4">Produtos Piores Avaliados</MudText>
                        @if (_produtosPioresAvaliados.Any())
                        {
                            <MudTable Items="@_produtosPioresAvaliados" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Produto</MudTh>
                                    <MudTh align="Align.Center">Avaliação</MudTh>
                                    <MudTh align="Align.Right">Total</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Produto">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            @if (!string.IsNullOrEmpty(context.ImagemUrl))
                                            {
                                                <MudAvatar Size="Size.Small" Style="width: 40px; height: 40px;">
                                                    <img src="@context.ImagemUrl" alt="@context.Nome" style="width: 100%; height: 100%; object-fit: cover;" />
                                                </MudAvatar>
                                            }
                                            <MudText Typo="Typo.body2">@context.Nome</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Avaliação" align="Align.Center">
                                        <RatingDisplay Rating="@context.MediaAvaliacao" StarSize="0.875rem" />
                                    </MudTd>
                                    <MudTd DataLabel="Total" align="Align.Right">@context.TotalAvaliacoes</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                                Nenhuma avaliação encontrada.
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
        }
    }
</MudContainer>

@code {
    [Inject] private ILogger<Analytics>? logger { get; set; }

    private enum TipoMensagem
    {
        Nenhuma,
        Validacao,
        DadosVazios,
        Critico
    }

    private bool _carregando = false;
    private string? _mensagem;
    private TipoMensagem _tipoMensagem = TipoMensagem.Nenhuma;
    private PeriodFilter _periodoFiltro = PeriodFilter.EsteMes;
    private DateTime? _dataInicio;
    private DateTime? _dataFim;
    private int _topItems = 10;

    private DashboardSummaryDto _resumo = new();
    private IReadOnlyList<SalesByPeriodDto> _vendasPorPeriodo = Array.Empty<SalesByPeriodDto>();
    private IReadOnlyList<ProductSalesDto> _produtosMaisVendidos = Array.Empty<ProductSalesDto>();
    private IReadOnlyList<Product> _produtosMenorEstoque = Array.Empty<Product>();
    private IReadOnlyList<ProductRatingDto> _produtosMelhoresAvaliados = Array.Empty<ProductRatingDto>();
    private IReadOnlyList<ProductRatingDto> _produtosPioresAvaliados = Array.Empty<ProductRatingDto>();
    private IReadOnlyList<OrderStatusCountDto> _pedidosPorStatus = Array.Empty<OrderStatusCountDto>();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDadosAsync();
    }

    private (bool Valido, string? Mensagem) ValidarEntradas()
    {
        if (_periodoFiltro == PeriodFilter.Personalizado)
        {
            if (!_dataInicio.HasValue || !_dataFim.HasValue)
            {
                return (false, "Por favor, preencha ambas as datas quando usar período personalizado.");
            }

            if (_dataInicio.Value > _dataFim.Value)
            {
                return (false, "A data de início deve ser anterior ou igual à data de fim.");
            }

            var agora = DateTime.UtcNow;
            if (_dataFim.Value > agora)
            {
                return (false, "A data de fim não pode ser futura.");
            }
        }
        return (true, null);
    }

    private bool VerificarDadosVazios()
    {
        return _resumo.TotalPedidos == 0
            && !_vendasPorPeriodo.Any()
            && !_produtosMaisVendidos.Any()
            && !_pedidosPorStatus.Any();
    }

    private async Task CarregarDadosAsync()
    {
        _carregando = true;
        _mensagem = null;
        _tipoMensagem = TipoMensagem.Nenhuma;

        try
        {
            // 1. Validar entradas antes de processar
            var (valido, mensagemValidacao) = ValidarEntradas();
            if (!valido)
            {
                _mensagem = mensagemValidacao;
                _tipoMensagem = TipoMensagem.Validacao;
                return;
            }

            var dataInicio = _periodoFiltro == PeriodFilter.Personalizado ? _dataInicio : null;
            var dataFim = _periodoFiltro == PeriodFilter.Personalizado ? _dataFim : null;

            // 2. Consulta consolidada para estatísticas relacionadas a pedidos/vendas
            var analyticsCompleto = await AnalyticsService.ObterAnalyticsCompletoAsync(
                _periodoFiltro, 
                _topItems, 
                dataInicio, 
                dataFim);

            _resumo = analyticsCompleto.Resumo;
            _vendasPorPeriodo = analyticsCompleto.VendasPorPeriodo;
            _produtosMaisVendidos = analyticsCompleto.ProdutosMaisVendidos;
            _pedidosPorStatus = analyticsCompleto.PedidosPorStatus;

            // 3. Consultas de produtos sequencialmente (evita concorrência no DbContext)
            _produtosMenorEstoque = await AnalyticsService.ObterProdutosMenorEstoqueAsync(_topItems);
            _produtosMelhoresAvaliados = await AnalyticsService.ObterProdutosMelhoresAvaliadosAsync(_topItems);
            _produtosPioresAvaliados = await AnalyticsService.ObterProdutosPioresAvaliadosAsync(_topItems);

            // 4. Verificar se não há dados para o período
            if (VerificarDadosVazios())
            {
                _mensagem = "Não há dados disponíveis para o período selecionado.";
                _tipoMensagem = TipoMensagem.DadosVazios;
            }
        }
        catch (BusinessException ex)
        {
            _mensagem = ex.Message;
            _tipoMensagem = TipoMensagem.Critico;
            logger?.LogError(ex, "Erro ao carregar estatísticas do dashboard: {Message}", ex.Message);
        }
        catch (Exception ex)
        {
            _mensagem = "Erro inesperado ao carregar estatísticas. Tente novamente.";
            _tipoMensagem = TipoMensagem.Critico;
            logger?.LogError(ex, "Erro inesperado ao carregar estatísticas do dashboard");
        }
        finally
        {
            _carregando = false;
            StateHasChanged();
        }
    }

    private Severity ObterSeveridadeMensagem(TipoMensagem tipo)
    {
        return tipo switch
        {
            TipoMensagem.Validacao => Severity.Warning,
            TipoMensagem.DadosVazios => Severity.Info,
            TipoMensagem.Critico => Severity.Error,
            _ => Severity.Info
        };
    }

    private string ObterIconeMensagem(TipoMensagem tipo)
    {
        return tipo switch
        {
            TipoMensagem.Validacao => Icons.Material.Filled.Warning,
            TipoMensagem.DadosVazios => Icons.Material.Filled.Info,
            TipoMensagem.Critico => Icons.Material.Filled.Error,
            _ => Icons.Material.Filled.Info
        };
    }

    private Color ObterCorStatus(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Processando => Color.Info,
            OrderStatus.Confirmado => Color.Primary,
            OrderStatus.EmPreparacao => Color.Warning,
            OrderStatus.Enviado => Color.Info,
            OrderStatus.Entregue => Color.Success,
            OrderStatus.Cancelado => Color.Error,
            _ => Color.Default
        };
    }
}

