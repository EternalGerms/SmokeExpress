@page "/admin/pedidos"
@attribute [Authorize(Roles = "Admin")]
@using MudBlazor
@inject IOrderService OrderService

<MudPaper Class="pa-6">
    <MudStack Spacing="4">
        <MudText Typo="Typo.h5" Class="fw-bold">Gestão de Pedidos</MudText>

        @if (_loading)
        {
            <MudStack Spacing="2">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body1" Class="text-center">Carregando pedidos...</MudText>
            </MudStack>
        }
        else if (!string.IsNullOrEmpty(_erro))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">
                @_erro
            </MudAlert>
        }
        else
        {
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-2">
                <MudTextField @bind-Value="_filtro"
                              Placeholder="Filtrar por id, cliente ou e-mail"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Class="mud-width-full" />

                <MudSelect T="OrderStatus?" @bind-Value="_statusFiltro"
                           Label="Status"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Style="min-width: 220px;">
                    <MudSelectItem T="OrderStatus?" Value="@( (OrderStatus?)null )">Todos os status</MudSelectItem>
                    @foreach (var s in _statusOptions)
                    {
                        <MudSelectItem T="OrderStatus?" Value="@s.Value">@s.Label</MudSelectItem>
                    }
                </MudSelect>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="RecarregarAsync">
                    Atualizar
                </MudButton>
            </MudStack>

            <MudPaper Elevation="1">
                <MudDataGrid T="OrderRow"
                             Items="Filtrar(_pedidos)"
                             Hover="true"
                             Dense="true"
                             RowStyleFunc="GetRowStyle">
                    <Columns>
                        <PropertyColumn Property="@(p => p.Id)" Title="#" />
                        <TemplateColumn Title="Cliente" Width="35%">
                            <CellTemplate>
                                <MudText Typo="Typo.body2" Class="text-truncate">@context.Item.ClienteNome</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-truncate">@context.Item.ClienteEmail</MudText>
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="@(p => p.DataLocal)" Title="Data" />
                        <TemplateColumn Title="Total">
                            <CellTemplate>
                                <MudText Typo="Typo.body2">@context.Item.TotalTexto</MudText>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Status">
                            <CellTemplate>
                                <MudSelect T="OrderStatus"
                                           Value="context.Item.Status"
                                           ValueChanged="async s => { context.Item.Status = s; await OnStatusChangedAsync(context.Item); }"
                                           Dense="true"
                                           Variant="Variant.Outlined"
                                           Style="min-width: 180px;">
                                    @foreach (var s in _statusOptions)
                                    {
                                        <MudSelectItem T="OrderStatus" Value="@s.Value">@s.Label</MudSelectItem>
                                    }
                                </MudSelect>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Ações">
                            <CellTemplate>
                                <MudButton Size="Size.Small"
                                           Variant="Variant.Text"
                                           Color="Color.Primary"
                                           OnClick="@(async () => await AbrirDetalhesAsync(context.Item.Id))"
                                           StartIcon="@Icons.Material.Filled.Visibility">
                                    Ver
                                </MudButton>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <PagerContent>
                        <MudDataGridPager T="OrderRow" PageSizeOptions="new int[] { 10, 20, 50 }" />
                    </PagerContent>
                </MudDataGrid>
            </MudPaper>
        }
    </MudStack>
</MudPaper>

@if (_detalhes is not null)
{
    <div class="modal fade show" style="display:block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pedido #@_detalhes.Id</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="FecharDetalhes"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <strong>Cliente</strong>
                            <div>@_detalhes.ClienteNome</div>
                            <div class="text-muted">@_detalhes.ClienteEmail</div>
                        </div>
                        <div class="col-md-6">
                            <strong>Data</strong>
                            <div>@_detalhes.DataLocal</div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <strong>Endereço de entrega</strong>
                        <div>@_detalhes.Rua, @_detalhes.Numero - @_detalhes.Bairro, @_detalhes.Cidade @_detalhes.Complemento</div>
                    </div>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th class="text-end">Qtd</th>
                                <th class="text-end">Preço</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in _detalhes.Itens)
                            {
                                <tr>
                                    <td>@i.Nome</td>
                                    <td class="text-end">@i.Quantidade</td>
                                    <td class="text-end">@i.PrecoUnitario.ToString("C")</td>
                                    <td class="text-end">@((i.PrecoUnitario * i.Quantidade).ToString("C"))</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Subtotal</th>
                                <th class="text-end">@_detalhes.Subtotal.ToString("C")</th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Frete</th>
                                <th class="text-end">@_detalhes.Frete.ToString("C")</th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-end">Total</th>
                                <th class="text-end">@_detalhes.TotalPedido.ToString("C")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private bool _loading = true;
    private string? _erro;
    private string _filtro = string.Empty;
    private OrderStatus? _statusFiltro = null;
    private IReadOnlyList<OrderRow> _pedidos = Array.Empty<OrderRow>();
    private OrderDetails? _detalhes;

    private readonly (OrderStatus Value, string Label)[] _statusOptions = new[]
    {
        (OrderStatus.Processando, "Processando"),
        (OrderStatus.Confirmado, "Confirmado"),
        (OrderStatus.EmPreparacao, "Em preparação"),
        (OrderStatus.Enviado, "Enviado"),
        (OrderStatus.Entregue, "Entregue"),
        (OrderStatus.Cancelado, "Cancelado")
    };

    protected override async Task OnInitializedAsync()
    {
        await RecarregarAsync();
    }

    private async Task RecarregarAsync()
    {
        _loading = true;
        _erro = null;
        try
        {
            var list = await OrderService.ListarTodosAsync();
            _pedidos = list.Select(o => new OrderRow
            {
                Id = o.Id,
                ClienteNome = o.Cliente?.NomeCompleto ?? "",
                ClienteEmail = o.Cliente?.Email ?? "",
                DataLocal = o.DataPedido.ToLocalTime().ToString("g"),
                TotalTexto = o.TotalPedido.ToString("C"),
                Status = o.Status
            }).ToList();
        }
        catch (Exception ex)
        {
            _erro = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private IEnumerable<OrderRow> Filtrar(IEnumerable<OrderRow> source)
    {
        if (_statusFiltro.HasValue)
        {
            source = source.Where(p => p.Status == _statusFiltro.Value);
        }

        if (string.IsNullOrWhiteSpace(_filtro))
            return source;

        var f = _filtro.Trim().ToLowerInvariant();
        return source.Where(p => p.Id.ToString().Contains(f)
            || (p.ClienteNome?.ToLowerInvariant().Contains(f) ?? false)
            || (p.ClienteEmail?.ToLowerInvariant().Contains(f) ?? false));
    }

    private async Task OnStatusChangedAsync(OrderRow row)
    {
        try
        {
            var ok = await OrderService.AtualizarStatusAsync(row.Id, row.Status);
            if (!ok)
            {
                _erro = "Não foi possível atualizar o status.";
            }
        }
        catch (Exception ex)
        {
            _erro = ex.Message;
        }
    }

    private async Task AbrirDetalhesAsync(int id)
    {
        _detalhes = null;
        var o = await OrderService.ObterPorIdAsync(id);
        if (o is null) return;
        _detalhes = new OrderDetails
        {
            Id = o.Id,
            ClienteNome = o.Cliente?.NomeCompleto ?? string.Empty,
            ClienteEmail = o.Cliente?.Email ?? string.Empty,
            DataLocal = o.DataPedido.ToLocalTime().ToString("g"),
            Rua = o.Rua,
            Numero = o.Numero,
            Bairro = o.Bairro,
            Cidade = o.Cidade,
            Complemento = o.Complemento,
            TotalPedido = o.TotalPedido,
            Itens = o.Itens.Select(i => new OrderItemRow
            {
                Nome = i.Product?.Nome ?? $"Produto {i.ProductId}",
                Quantidade = i.Quantidade,
                PrecoUnitario = i.PrecoUnitario
            }).ToList()
        };
        _detalhes.Subtotal = _detalhes.Itens.Sum(i => i.PrecoUnitario * i.Quantidade);
        _detalhes.Frete = _detalhes.TotalPedido - _detalhes.Subtotal;
        StateHasChanged();
    }

    private void FecharDetalhes() => _detalhes = null;

    private string GetRowStyle(OrderRow _, int __)
        => "height: 26px;";

    private sealed class OrderRow
    {
        public int Id { get; set; }
        public string ClienteNome { get; set; } = string.Empty;
        public string ClienteEmail { get; set; } = string.Empty;
        public string DataLocal { get; set; } = string.Empty;
        public string TotalTexto { get; set; } = string.Empty;
        public OrderStatus Status { get; set; }
    }

    private sealed class OrderDetails
    {
        public int Id { get; set; }
        public string ClienteNome { get; set; } = string.Empty;
        public string ClienteEmail { get; set; } = string.Empty;
        public string DataLocal { get; set; } = string.Empty;
        public string Rua { get; set; } = string.Empty;
        public string? Numero { get; set; }
        public string Bairro { get; set; } = string.Empty;
        public string Cidade { get; set; } = string.Empty;
        public string? Complemento { get; set; }
        public decimal Subtotal { get; set; }
        public decimal Frete { get; set; }
        public decimal TotalPedido { get; set; }
        public List<OrderItemRow> Itens { get; set; } = new();
    }

    private sealed class OrderItemRow
    {
        public string Nome { get; set; } = string.Empty;
        public int Quantidade { get; set; }
        public decimal PrecoUnitario { get; set; }
    }
}


