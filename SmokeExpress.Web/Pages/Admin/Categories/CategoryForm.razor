@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using SmokeExpress.Web.Exceptions
@inject ILogger<CategoryForm> Logger

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

<EditForm Model="@_model" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary class="text-danger mb-3" />

    <div class="row">
        <div class="col-md-8">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome <span class="text-danger">*</span></label>
                <InputText id="nome" class="form-control" @bind-Value="_model.Nome" />
                <ValidationMessage For="@(() => _model.Nome)" />
            </div>

            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição</label>
                <InputTextArea id="descricao" class="form-control" rows="5" @bind-Value="_model.Descricao" />
                <ValidationMessage For="@(() => _model.Descricao)" />
                <small class="form-text text-muted">Descrição opcional da categoria para ajudar na organização.</small>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary" disabled="@_salvando">
            @if (_salvando)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Salvando...</span>
            }
            else
            {
                <span>Salvar</span>
            }
        </button>
        <a href="/admin/categorias" class="btn btn-secondary">Cancelar</a>
    </div>
</EditForm>

@code {
    [Parameter]
    public Category? Categoria { get; set; }

    [Parameter]
    public EventCallback<Category> OnSave { get; set; }

    private CategoryFormModel _model = new();
    private bool _salvando = false;

    protected override void OnInitialized()
    {
        if (Categoria != null)
        {
            _model.Nome = Categoria.Nome;
            _model.Descricao = Categoria.Descricao ?? string.Empty;
        }
    }

    private async Task HandleValidSubmit()
    {
        _salvando = true;

        try
        {
            var categoria = Categoria ?? new Category();

            categoria.Nome = _model.Nome;
            categoria.Descricao = string.IsNullOrWhiteSpace(_model.Descricao) ? null : _model.Descricao;

            await OnSave.InvokeAsync(categoria);
        }
        catch (BusinessException ex)
        {
            Logger.LogError(ex, "Erro ao salvar categoria: {Message}", ex.Message);
        }
        catch (ValidationException ex)
        {
            Logger.LogError(ex, "Erro de validação ao salvar categoria: {Message}", ex.Message);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro inesperado ao salvar categoria");
        }
        finally
        {
            _salvando = false;
        }
    }

    private class CategoryFormModel
    {
        [Required(ErrorMessage = "O nome é obrigatório")]
        [StringLength(120, ErrorMessage = "O nome deve ter no máximo 120 caracteres")]
        public string Nome { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "A descrição deve ter no máximo 500 caracteres")]
        public string? Descricao { get; set; }
    }
}

