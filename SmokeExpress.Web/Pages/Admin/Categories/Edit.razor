@page "/admin/categorias/{Id:int}/editar"
@attribute [Authorize(Roles = "Admin")]
@using SmokeExpress.Web.Exceptions
@inject ICategoryService CategoryService
@inject NavigationManager Navigation
@inject ILogger<Edit> Logger

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

@if (_carregando)
{
    <p>Carregando categoria...</p>
}
else if (_categoria == null)
{
    <div class="alert alert-warning" role="alert">
        <h4>Categoria não encontrada</h4>
        <p>A categoria solicitada não foi encontrada.</p>
        <a href="/admin/categorias" class="btn btn-primary">Voltar para listagem</a>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Editar Categoria</h3>
        <button type="button" class="btn btn-danger" @onclick="PrepararExclusao">
            <span class="oi oi-trash" aria-hidden="true"></span> Excluir
        </button>
    </div>

    @if (!string.IsNullOrEmpty(_mensagemErro))
    {
        <div class="alert alert-danger" role="alert">@_mensagemErro</div>
    }

    <CategoryForm Categoria="_categoria" OnSave="HandleSave" />
}

<!-- Modal de Confirmação de Exclusão -->
@if (_mostrarModalExclusao)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" @onclick="CancelarExclusao" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir a categoria <strong>@(_categoria?.Nome)</strong>?</p>
                    @if (_categoria != null && _categoria.Produtos.Count > 0)
                    {
                        <div class="alert alert-warning" role="alert">
                            <strong>Atenção:</strong> Esta categoria possui @_categoria.Produtos.Count produto(s) associado(s). 
                            Não é possível excluir categorias com produtos.
                        </div>
                    }
                    <p class="text-danger"><small>Esta ação não pode ser desfeita.</small></p>
                    @if (!string.IsNullOrEmpty(_erroExclusao))
                    {
                        <div class="alert alert-danger" role="alert">@_erroExclusao</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelarExclusao">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmarExclusao" disabled="@(_excluindo || (_categoria != null && _categoria.Produtos.Count > 0))">
                        @if (_excluindo)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Excluindo...</span>
                        }
                        else
                        {
                            <span>Excluir</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Category? _categoria;
    private bool _carregando = true;
    private string? _mensagemErro;

    // Exclusão
    private bool _mostrarModalExclusao = false;
    private bool _excluindo = false;
    private string? _erroExclusao;

    protected override async Task OnInitializedAsync()
    {
        await CarregarCategoriaAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await CarregarCategoriaAsync();
    }

    private async Task CarregarCategoriaAsync()
    {
        _carregando = true;
        _mensagemErro = null;

        try
        {
            _categoria = await CategoryService.ObterPorIdAsync(Id);
        }
        catch (NotFoundException ex)
        {
            Logger.LogError(ex, "Categoria {Id} não encontrada", Id);
            _mensagemErro = ex.Message;
        }
        catch (BusinessException ex)
        {
            Logger.LogError(ex, "Erro ao carregar categoria {Id}: {Message}", Id, ex.Message);
            _mensagemErro = ex.Message;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro inesperado ao carregar categoria {Id}", Id);
            _mensagemErro = "Erro inesperado ao carregar a categoria. Tente novamente.";
        }
        finally
        {
            _carregando = false;
        }
    }

    private async Task HandleSave(Category categoria)
    {
        _mensagemErro = null;

        try
        {
            await CategoryService.AtualizarAsync(categoria);
            Navigation.NavigateTo("/admin/categorias?success=updated");
        }
        catch (BusinessException ex)
        {
            Logger.LogError(ex, "Erro ao atualizar categoria {Id}: {Message}", Id, ex.Message);
            _mensagemErro = ex.Message;
            StateHasChanged();
        }
        catch (ValidationException ex)
        {
            Logger.LogError(ex, "Erro de validação ao atualizar categoria {Id}: {Message}", Id, ex.Message);
            _mensagemErro = ex.Message;
            StateHasChanged();
        }
        catch (NotFoundException ex)
        {
            Logger.LogError(ex, "Categoria {Id} não encontrada para atualização", Id);
            _mensagemErro = ex.Message;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro inesperado ao atualizar categoria {Id}", Id);
            _mensagemErro = "Erro inesperado ao atualizar categoria. Tente novamente.";
            StateHasChanged();
        }
    }

    private void PrepararExclusao()
    {
        _mostrarModalExclusao = true;
        _erroExclusao = null;
        StateHasChanged();
    }

    private void CancelarExclusao()
    {
        _mostrarModalExclusao = false;
        _erroExclusao = null;
        StateHasChanged();
    }

    private async Task ConfirmarExclusao()
    {
        if (_categoria == null) return;

        _excluindo = true;
        _erroExclusao = null;
        StateHasChanged();

        try
        {
            await CategoryService.RemoverAsync(_categoria.Id);
            Navigation.NavigateTo("/admin/categorias?success=deleted");
        }
        catch (BusinessException ex)
        {
            Logger.LogError(ex, "Erro ao excluir categoria {Id}: {Message}", Id, ex.Message);
            _erroExclusao = ex.Message;
        }
        catch (ValidationException ex)
        {
            Logger.LogError(ex, "Erro de validação ao excluir categoria {Id}: {Message}", Id, ex.Message);
            _erroExclusao = ex.Message;
        }
        catch (NotFoundException ex)
        {
            Logger.LogError(ex, "Categoria {Id} não encontrada para exclusão", Id);
            _erroExclusao = ex.Message;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro inesperado ao excluir categoria {Id}", Id);
            _erroExclusao = "Erro inesperado ao excluir categoria. Tente novamente.";
        }
        finally
        {
            _excluindo = false;
            StateHasChanged();
        }
    }
}

