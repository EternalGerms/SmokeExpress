@page "/admin/categorias"
@attribute [Authorize(Roles = "Admin")]
@using SmokeExpress.Web.Exceptions
@inject ICategoryService CategoryService
@inject NavigationManager Navigation

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Administração de Categorias</h3>
    <a href="/admin/categorias/novo" class="btn btn-primary">
        <span class="oi oi-plus" aria-hidden="true"></span> Nova Categoria
    </a>
</div>

@if (!string.IsNullOrEmpty(_mensagemErro))
{
    <div class="alert alert-danger" role="alert">@_mensagemErro</div>
}
else if (_carregando)
{
    <p>Carregando categorias...</p>
}
else if (_categorias.Count == 0)
{
    <div class="alert alert-info" role="alert">
        Nenhuma categoria cadastrada no momento. Crie uma categoria para começar a organizar seus produtos.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Nome</th>
                    <th>Descrição</th>
                    <th>Produtos</th>
                    <th style="width: 150px;">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var categoria in _categorias)
                {
                    <tr>
                        <td><strong>@categoria.Nome</strong></td>
                        <td>@(string.IsNullOrWhiteSpace(categoria.Descricao) ? "-" : categoria.Descricao)</td>
                        <td>
                            <span class="badge bg-secondary">@categoria.Produtos.Count produto(s)</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="@($"/admin/categorias/{categoria.Id}/editar")" class="btn btn-outline-primary" title="Editar">
                                    <span class="oi oi-pencil" aria-hidden="true"></span>
                                </a>
                                <button type="button" class="btn btn-outline-danger" @onclick="() => PrepararExclusao(categoria)" title="Excluir">
                                    <span class="oi oi-trash" aria-hidden="true"></span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!-- Modal de Confirmação de Exclusão -->
@if (_categoriaParaExcluir != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" @onclick="CancelarExclusao" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir a categoria <strong>@_categoriaParaExcluir.Nome</strong>?</p>
                    @if (_categoriaParaExcluir.Produtos.Count > 0)
                    {
                        <div class="alert alert-warning" role="alert">
                            <strong>Atenção:</strong> Esta categoria possui @_categoriaParaExcluir.Produtos.Count produto(s) associado(s). 
                            Não é possível excluir categorias com produtos.
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(_erroExclusao))
                    {
                        <div class="alert alert-danger" role="alert">@_erroExclusao</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelarExclusao">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmarExclusao" disabled="@(_excluindo || _categoriaParaExcluir.Produtos.Count > 0)">
                        @if (_excluindo)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>Excluindo...</span>
                        }
                        else
                        {
                            <span>Excluir</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private IReadOnlyList<Category> _categorias = Array.Empty<Category>();
    private bool _carregando = true;
    private string? _mensagemErro;

    // Exclusão
    private Category? _categoriaParaExcluir;
    private bool _excluindo = false;
    private string? _erroExclusao;

    protected override async Task OnInitializedAsync()
    {
        await CarregarCategoriasAsync();
    }

    private async Task CarregarCategoriasAsync()
    {
        _carregando = true;
        _mensagemErro = null;

        try
        {
            var categorias = await CategoryService.ListarAsync();
            _categorias = categorias.ToList();
        }
        catch (BusinessException ex)
        {
            _mensagemErro = ex.Message;
        }
        catch (Exception ex)
        {
            _mensagemErro = "Erro inesperado ao carregar as categorias. Tente novamente.";
        }
        finally
        {
            _carregando = false;
        }
    }

    private void PrepararExclusao(Category categoria)
    {
        _categoriaParaExcluir = categoria;
        _erroExclusao = null;
        StateHasChanged();
    }

    private void CancelarExclusao()
    {
        _categoriaParaExcluir = null;
        _erroExclusao = null;
        StateHasChanged();
    }

    private async Task ConfirmarExclusao()
    {
        if (_categoriaParaExcluir == null) return;

        _excluindo = true;
        _erroExclusao = null;
        StateHasChanged();

        try
        {
            await CategoryService.RemoverAsync(_categoriaParaExcluir.Id);
            await CarregarCategoriasAsync();
            _categoriaParaExcluir = null;
        }
        catch (BusinessException ex)
        {
            _erroExclusao = ex.Message;
        }
        catch (ValidationException ex)
        {
            _erroExclusao = ex.Message;
        }
        catch (NotFoundException ex)
        {
            _erroExclusao = ex.Message;
        }
        catch (Exception ex)
        {
            _erroExclusao = "Erro inesperado ao excluir categoria. Tente novamente.";
        }
        finally
        {
            _excluindo = false;
            StateHasChanged();
        }
    }
}

