@page "/admin/categorias"
@attribute [Authorize(Roles = "Admin")]
@using MudBlazor
@inject ICategoryService CategoryService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

@* Projeto Smoke Express - Autores: Bruno Bueno e Matheus Esposto *@

<MudPaper Class="pa-6">
    <MudStack Spacing="4">
        <MudBreadcrumbs Items="@_breadcrumbItems" Class="mb-1" />
        <MudText Typo="Typo.h5" Class="fw-bold">Administração de Categorias</MudText>

        @if (!string.IsNullOrEmpty(_mensagemErro))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">
                @_mensagemErro
            </MudAlert>
        }
        else if (_carregando)
        {
            <MudStack Spacing="2">
                <MudSkeleton Height="52px" />
                <MudSkeleton Height="52px" />
                <MudSkeleton Height="52px" />
            </MudStack>
        }
        else if (_categorias.Count == 0)
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                Nenhuma categoria cadastrada. Clique em <strong>Nova Categoria</strong> para começar.
            </MudAlert>
        }
        else
        {
            <MudPaper Elevation="1">
                <MudDataGrid Items="_categorias"
                             Hover="true"
                             Dense="true"
                             Filterable="true"
                             RowClick="@(async (DataGridRowClickEventArgs<Category> args) => await AbrirModalEdicao(args.Item))">
                    <ToolBarContent>
                        <MudText Typo="Typo.subtitle2" Class="ml-2">Total: @_categorias.Count</MudText>
                        <MudSpacer />
                        <MudButton StartIcon="@Icons.Material.Filled.Add"
                                   Color="Color.Primary"
                                   Variant="Variant.Outlined"
                                   OnClick="@AbrirModalNovaCategoria">
                            Nova Categoria
                        </MudButton>
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="@(c => c.Nome)" Title="Nome" SortBy="@(c => c.Nome)" />
                        <TemplateColumn Title="Descrição">
                            <CellTemplate>
                                @if (string.IsNullOrWhiteSpace(context.Item.Descricao))
                                {
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">-</MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2">@context.Item.Descricao</MudText>
                                }
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Produtos" CellClass="text-start">
                            <CellTemplate>
                                <MudChip Color="Color.Secondary"
                                         Variant="Variant.Filled"
                                         Size="Size.Small">
                                    @((context.Item.Produtos?.Count ?? 0)) produto(s)
                                </MudChip>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Ações" CellClass="text-start">
                            <CellTemplate>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Primary"
                                               OnClick="@(() => AbrirModalEdicao(context.Item))"
                                               aria-label="Editar categoria" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               OnClick="@(() => ConfirmarExclusao(context.Item))"
                                               aria-label="Excluir categoria" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudPaper>
        }

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="@Voltar"
                   Class="mt-2 align-self-start">
            Voltar
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    private readonly List<Category> _categorias = new();
    private bool _carregando = true;
    private string? _mensagemErro;
    private List<BreadcrumbItem> _breadcrumbItems = new();

    protected override async Task OnInitializedAsync()
    {
        _breadcrumbItems = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem("Admin", href: "/admin", icon: Icons.Material.Filled.Dashboard),
            new BreadcrumbItem("Categorias", href: null, icon: Icons.Material.Filled.Category, disabled: true)
        };

        await CarregarCategoriasAsync();
    }

    private async Task CarregarCategoriasAsync()
    {
        _carregando = true;
        _mensagemErro = null;

        try
        {
            var categorias = await CategoryService.ListarAsync();
            _categorias.Clear();
            _categorias.AddRange(categorias);
        }
        catch (Exception ex)
        {
            _mensagemErro = $"Erro ao carregar as categorias: {ex.Message}";
        }
        finally
        {
            _carregando = false;
            StateHasChanged();
        }
    }

    private Task AbrirModalNovaCategoria()
        => AbrirModalCategoria(null);

    private Task AbrirModalEdicao(Category categoria)
        => AbrirModalCategoria(categoria);

    private async Task AbrirModalCategoria(Category? categoria)
    {
        var titulo = categoria is null ? "Nova Categoria" : "Editar Categoria";

        var parameters = new DialogParameters<CategoryDialog>
        {
            { nameof(CategoryDialog.Categoria), categoria }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialogReference = await DialogService.ShowAsync<CategoryDialog>(titulo, parameters, options);
        if (dialogReference is null)
        {
            return;
        }

        var resultado = await dialogReference.Result;

        if (!resultado.Canceled && resultado.Data is Category categoriaResultado)
        {
            await SalvarCategoriaAsync(categoriaResultado);
        }
    }

    private async Task SalvarCategoriaAsync(Category categoria)
    {
        try
        {
            if (categoria.Id > 0)
            {
                await CategoryService.AtualizarAsync(categoria);
                Snackbar.Add($"Categoria '{categoria.Nome}' atualizada com sucesso.", Severity.Success);
            }
            else
            {
                await CategoryService.CriarAsync(categoria);
                Snackbar.Add($"Categoria '{categoria.Nome}' criada com sucesso.", Severity.Success);
            }

            await CarregarCategoriasAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar categoria: {ex.Message}", Severity.Error);
        }
    }

    private async Task ConfirmarExclusao(Category categoria)
    {
        if (categoria.Produtos?.Any() == true)
        {
            await DialogService.ShowMessageBox(
                title: "Exclusão não permitida",
                message: $"A categoria '{categoria.Nome}' possui produtos associados e não pode ser excluída. Remova ou mova os produtos antes de tentar novamente.",
                yesText: "Entendi",
                options: new DialogOptions { CloseButton = true, BackdropClick = false });
            return;
        }

        bool? confirmacao = await DialogService.ShowMessageBox(
            title: "Confirmar exclusão",
            message: $"Deseja realmente excluir a categoria '{categoria.Nome}'?",
            yesText: "Excluir",
            cancelText: "Cancelar",
            options: new DialogOptions { CloseButton = true, BackdropClick = false });

        if (confirmacao == true)
        {
            try
            {
                await CategoryService.RemoverAsync(categoria.Id);
                Snackbar.Add($"Categoria '{categoria.Nome}' removida com sucesso.", Severity.Success);
                await CarregarCategoriasAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir categoria: {ex.Message}", Severity.Error);
            }
        }
    }

    private void Voltar()
        => Navigation.NavigateTo("/admin");
}

