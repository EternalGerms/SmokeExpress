@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using SmokeExpress.Web.Models

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" Model="_model">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_model.Nome"
                              For="@(() => _model.Nome)"
                              Label="Nome"
                              Required="true"
                              Immediate="true"
                              MaxLength="120"
                              Variant="Variant.Outlined"
                              InputType="InputType.Text" />

                <MudTextField @bind-Value="_model.Descricao"
                              For="@(() => _model.Descricao)"
                              Label="Descrição"
                              Placeholder="Opcional"
                              Lines="4"
                              MaxLength="500"
                              Variant="Variant.Outlined"
                              InputType="InputType.Text" />
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Secondary"
                   OnClick="Cancelar">
            Cancelar
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Salvar">
            Salvar
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public Category? Categoria { get; set; }

    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private MudForm? _form;
    private readonly CategoryDialogModel _model = new();

    protected override void OnInitialized()
    {
        if (Categoria is not null)
        {
            _model.Id = Categoria.Id;
            _model.Nome = Categoria.Nome;
            _model.Descricao = Categoria.Descricao;
        }
    }

    private async Task Salvar()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();

        if (!_form.IsValid)
        {
            return;
        }

        var categoria = new Category
        {
            Id = _model.Id ?? 0,
            Nome = _model.Nome.Trim(),
            Descricao = string.IsNullOrWhiteSpace(_model.Descricao)
                ? null
                : _model.Descricao.Trim()
        };

        MudDialog?.Close(DialogResult.Ok(categoria));
    }

    private void Cancelar()
    {
        MudDialog?.Cancel();
    }

    private sealed class CategoryDialogModel
    {
        public int? Id { get; set; }

        [Required(ErrorMessage = "O nome é obrigatório.")]
        [StringLength(120, ErrorMessage = "O nome deve ter no máximo 120 caracteres.")]
        public string Nome { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "A descrição deve ter no máximo 500 caracteres.")]
        public string? Descricao { get; set; }
    }
}

