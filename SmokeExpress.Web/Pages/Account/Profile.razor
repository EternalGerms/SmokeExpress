@page "/account/profile"
@attribute [Authorize]
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using SmokeExpress.Web.Models
@using SmokeExpress.Web.Services
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IOrderService OrderService
@inject IAddressService AddressService
@inject IDialogService DialogService
@inject IReviewService ReviewService
@inject ILogger<Profile> Logger

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" Class="mr-2" />
        Minha Conta
    </MudText>

@if (_loading)
{
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        <MudText Typo="Typo.body1" Class="text-center">Carregando seus dados...</MudText>
}
else if (!string.IsNullOrEmpty(_erro))
{
        <MudAlert Severity="Severity.Error" Class="mb-4" Dismissible="true" OnClose="@(() => _erro = null)">
            <MudText Typo="Typo.body1">@_erro</MudText>
        </MudAlert>
}
else
{
        <MudTabs Elevation="2" Rounded="true" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTabIndex">
            <!-- Aba: Perfil -->
            <MudTabPanel Text="Perfil" Icon="@Icons.Material.Filled.Person">
                <MudGrid Spacing="3">
                    <MudItem xs="12" md="8">
                        <MudStack Spacing="3">
                            <!-- Informações Pessoais (Somente Leitura) -->
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudText Typo="Typo.h6" Class="mb-4">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-2" />
                                        Informações Pessoais
                                    </MudText>
                                    <MudDivider Class="mb-4" />
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="6">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Nome Completo</MudText>
                                                <MudTextField Variant="Variant.Outlined" 
                                                            Value="@_model.NomeCompleto" 
                                                            ReadOnly="true"
                                                            Disabled="true"
                                                            Adornment="Adornment.Start"
                                                            AdornmentIcon="@Icons.Material.Filled.Badge" />
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">CPF/CNPJ</MudText>
                                                <MudTextField Variant="Variant.Outlined" 
                                                            Value="@_model.DocumentoFiscal" 
                                                            ReadOnly="true"
                                                            Disabled="true"
                                                            Adornment="Adornment.Start"
                                                            AdornmentIcon="@Icons.Material.Filled.CreditCard" />
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Data de Nascimento</MudText>
                                                <MudTextField Variant="Variant.Outlined" 
                                                            Value="@DataNascimentoFormatada" 
                                                            ReadOnly="true"
                                                            Disabled="true"
                                                            Adornment="Adornment.Start"
                                                            AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Gênero</MudText>
                                                <MudTextField Variant="Variant.Outlined" 
                                                            Value="@_model.Genero" 
                                                            ReadOnly="true"
                                                            Disabled="true"
                                                            Adornment="Adornment.Start"
                                                            AdornmentIcon="@Icons.Material.Filled.PersonOutline" />
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Tipo de Cliente</MudText>
                                                <MudChip T="string" Size="Size.Medium" 
                                                        Color="Color.Primary" 
                                                        Variant="Variant.Filled"
                                                        Icon="@Icons.Material.Filled.Star">
                                                    @_model.TipoCliente
                                                </MudChip>
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>

                            <!-- Editar E-mail -->
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudText Typo="Typo.h6" Class="mb-4">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-2" />
                                        E-mail
                                    </MudText>
                                    <MudDivider Class="mb-4" />
                                    <EditForm Model="_emailModel" OnValidSubmit="AtualizarEmailAsync">
                    <DataAnnotationsValidator />
                                        <MudStack Spacing="3">
                                            <MudTextField @bind-Value="_emailModel.Email" 
                                                        Label="E-mail" 
                                                        Variant="Variant.Outlined"
                                                        Adornment="Adornment.Start"
                                                        AdornmentIcon="@Icons.Material.Filled.Email"
                                                        Required="true"
                                                        RequiredError="E-mail é obrigatório"
                                                        HelperText="Digite seu novo endereço de e-mail"
                                                        InputType="InputType.Email" />
                                            <MudButton Variant="Variant.Filled" 
                                                      Color="Color.Primary" 
                                                      ButtonType="ButtonType.Submit"
                                                      StartIcon="@Icons.Material.Filled.Save"
                                                      Disabled="@_saving"
                                                      FullWidth="true">
                                                @(_saving ? "Salvando..." : "Atualizar E-mail")
                                            </MudButton>
                                        </MudStack>
                </EditForm>
                                </MudCardContent>
                            </MudCard>

                            <!-- Alterar Senha -->
                            <MudCard Elevation="1">
                                <MudCardContent>
                                    <MudText Typo="Typo.h6" Class="mb-4">
                                        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Class="mr-2" />
                                        Alterar Senha
                                    </MudText>
                                    <MudDivider Class="mb-4" />
                <EditForm Model="_senha" OnValidSubmit="AlterarSenhaAsync">
                    <DataAnnotationsValidator />
                                        <MudStack Spacing="3">
                                            <MudTextField @bind-Value="_senha.SenhaAtual" 
                                                        Label="Senha Atual" 
                                                        Variant="Variant.Outlined"
                                                        Adornment="Adornment.Start"
                                                        AdornmentIcon="@Icons.Material.Filled.Lock"
                                                        InputType="InputType.Password"
                                                        Required="true"
                                                        RequiredError="Senha atual é obrigatória" />
                                            <MudTextField @bind-Value="_senha.NovaSenha" 
                                                        Label="Nova Senha" 
                                                        Variant="Variant.Outlined"
                                                        Adornment="Adornment.Start"
                                                        AdornmentIcon="@Icons.Material.Filled.LockOpen"
                                                        InputType="InputType.Password"
                                                        Required="true"
                                                        RequiredError="Nova senha é obrigatória"
                                                        HelperText="Mínimo de 8 caracteres" />
                                            <MudTextField @bind-Value="_senha.ConfirmacaoSenha" 
                                                        Label="Confirmar Nova Senha" 
                                                        Variant="Variant.Outlined"
                                                        Adornment="Adornment.Start"
                                                        AdornmentIcon="@Icons.Material.Filled.LockReset"
                                                        InputType="InputType.Password"
                                                        Required="true"
                                                        RequiredError="Confirmação de senha é obrigatória" />
                                            <MudButton Variant="Variant.Filled" 
                                                      Color="Color.Primary" 
                                                      ButtonType="ButtonType.Submit"
                                                      StartIcon="@Icons.Material.Filled.Security"
                                                      Disabled="@_saving"
                                                      FullWidth="true">
                                                @(_saving ? "Alterando..." : "Alterar Senha")
                                            </MudButton>
                                        </MudStack>
                </EditForm>
                                </MudCardContent>
                            </MudCard>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <!-- Resumo da Conta -->
                        <MudCard Elevation="1" Class="pa-4">
                            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                <MudAvatar Size="Size.Large" Class="mb-2">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountCircle" Size="Size.Large" />
                                </MudAvatar>
                                <MudText Typo="Typo.h6" Class="text-center">@_model.NomeCompleto</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center">@_model.Email</MudText>
                                <MudChip T="string" Size="Size.Small" 
                                        Color="Color.Success" 
                                        Variant="Variant.Filled"
                                        Icon="@Icons.Material.Filled.CheckCircle">
                                    Conta Ativa
                                </MudChip>
                            </MudStack>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <!-- Aba: Endereços -->
            <MudTabPanel Text="Endereços" Icon="@Icons.Material.Filled.Home">
                @if (_loadingEnderecos)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    <MudText Typo="Typo.body1" Class="text-center">Carregando endereços...</MudText>
                }
                else
                {
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-2" />
                                Meus Endereços
                            </MudText>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.Add"
                                      OnClick="NovoEndereco">
                                Novo Endereço
                            </MudButton>
                        </MudStack>

                        @if (_enderecos.Count == 0)
                        {
                            <MudPaper Elevation="1" Class="pa-8 text-center">
                                <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Large" Color="Color.Default" Class="mb-4" />
                                <MudText Typo="Typo.h6" Class="mb-2">Nenhum endereço cadastrado</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Adicione um endereço para facilitar suas compras.
                                </MudText>
                            </MudPaper>
                        }
                        else
                        {
                            <MudGrid Spacing="3">
                                @foreach (var endereco in _enderecos)
                                {
                                    <MudItem xs="12" md="6">
                                        <MudCard Elevation="1" Class="@(endereco.IsDefault ? "border-primary" : "")">
                                            <MudCardContent>
                                                <MudStack Spacing="2">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                        <MudText Typo="Typo.h6" Class="mb-0">
                                                            @FormatEndereco(endereco)
                                                        </MudText>
                                                        @if (endereco.IsDefault)
                                                        {
                                                            <MudChip T="string" Size="Size.Small" 
                                                                    Color="Color.Success" 
                                                                    Variant="Variant.Filled"
                                                                    Icon="@Icons.Material.Filled.Star">
                                                                Padrão
                                                            </MudChip>
                                                        }
                                                    </MudStack>
                                                    <MudDivider />
                                                    <MudStack Row="true" Spacing="2">
                                                        <MudButton Size="Size.Small" 
                                                                  Variant="Variant.Outlined" 
                                                                  Color="Color.Primary"
                                                                  StartIcon="@Icons.Material.Filled.Edit"
                                                                  OnClick="@(() => EditarEndereco(endereco))">
                                                            Editar
                                                        </MudButton>
                                                        @if (!endereco.IsDefault)
                                                        {
                                                            <MudButton Size="Size.Small" 
                                                                      Variant="Variant.Outlined" 
                                                                      Color="Color.Success"
                                                                      StartIcon="@Icons.Material.Filled.Star"
                                                                      OnClick="@(() => TornarPadraoEndereco(endereco))">
                                                                Tornar Padrão
                                                            </MudButton>
                                                        }
                                                        <MudButton Size="Size.Small" 
                                                                  Variant="Variant.Outlined" 
                                                                  Color="Color.Error"
                                                                  StartIcon="@Icons.Material.Filled.Delete"
                                                                  OnClick="@(() => ExcluirEndereco(endereco))">
                                                            Excluir
                                                        </MudButton>
                                                    </MudStack>
                                                </MudStack>
                                            </MudCardContent>
                                        </MudCard>
                                    </MudItem>
                                }
                            </MudGrid>
                        }
                    </MudStack>
                }
            </MudTabPanel>

            <!-- Aba: Pedidos -->
            <MudTabPanel Text="Pedidos" Icon="@Icons.Material.Filled.ShoppingBag">
                @if (_loadingPedidos)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    <MudText Typo="Typo.body1" Class="text-center">Carregando seus pedidos...</MudText>
                }
                else if (_erroPedidos is not null)
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">
                        <MudText Typo="Typo.body1">@_erroPedidos</MudText>
                    </MudAlert>
                }
                else if (_pedidos.Count == 0)
                {
                    <MudPaper Elevation="1" Class="pa-8 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingBag" Size="Size.Large" Color="Color.Default" Class="mb-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Você ainda não realizou nenhum pedido</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Quando você fizer um pedido, ele aparecerá aqui.
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/" Class="mt-4">
                            <MudIcon Icon="@Icons.Material.Filled.Store" Class="mr-2" />
                            Ir para a loja
                        </MudButton>
                    </MudPaper>
                }
                else
                {
                    <MudStack Spacing="3">
                        @foreach (var pedido in _pedidos)
                        {
                            <MudCard Elevation="2">
                                <MudCardContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-2">
                                        <MudText Typo="Typo.h6" Class="mb-0">Pedido #@pedido.Id</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(pedido.Status)" Variant="Variant.Filled">
                                            @pedido.StatusTexto
                                        </MudChip>
                                        <MudSpacer />
                                        <MudText Typo="Typo.body1" Class="mb-0 font-weight-bold">
                                            @pedido.TotalTexto
                                        </MudText>
                                    </MudStack>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@pedido.DataPedidoLocal</MudText>
                                        <MudSpacer />
                                        <MudButton Size="Size.Small" 
                                                  Variant="Variant.Text" 
                                                  Color="Color.Primary"
                                                  OnClick="@(() => TogglePedido(pedido))"
                                                  EndIcon="@(pedido.IsExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)">
                                            @(pedido.IsExpanded ? "Ocultar" : "Ver") detalhes
                                        </MudButton>
                                    </MudStack>
                                    
                                    @if (pedido.IsExpanded)
                                    {
                                        <div class="mt-4">
                                            @if (pedido.CarregandoDetalhes || (pedido.Detalhes is null && pedido.ErroDetalhes is null))
                                            {
                                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                                                <MudText Typo="Typo.body2" Class="text-center">Carregando detalhes...</MudText>
                                            }
                                            else if (pedido.Detalhes is not null)
                                            {
                                                <MudGrid Spacing="3" Class="mt-2">
                                                    <MudItem xs="12" md="8">
                                                        <MudCard Elevation="1" Class="pa-4">
                                                            <MudText Typo="Typo.h6" Class="mb-3">
                                                                <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Class="mr-2" />
                                                                Itens do Pedido
                                                            </MudText>
                                                            <MudTable Items="@pedido.Detalhes.Itens" Hover="true" Dense="true" Striped="true">
                                                                <HeaderContent>
                                                                    <MudTh>Produto</MudTh>
                                                                    <MudTh align="Align.Right">Quantidade</MudTh>
                                                                    <MudTh align="Align.Right">Preço Unit.</MudTh>
                                                                    <MudTh align="Align.Right">Subtotal</MudTh>
                                                                    @if (pedido.Status == OrderStatus.Entregue)
                                                                    {
                                                                        <MudTh align="Align.Center">Ações</MudTh>
                                                                    }
                                                                </HeaderContent>
                                                                <RowTemplate>
                                                                    <MudTd DataLabel="Produto">
                                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                            @if (!string.IsNullOrEmpty(context.ImagemUrl))
                                                                            {
                                                                                <MudAvatar Size="Size.Small" Style="width: 40px; height: 40px;">
                                                                                    <img src="@context.ImagemUrl" alt="@context.Nome" style="width: 100%; height: 100%; object-fit: cover;" />
                                                                                </MudAvatar>
                                                                            }
                                                                            <MudText Typo="Typo.body2">@context.Nome</MudText>
                                                                        </MudStack>
                                                                    </MudTd>
                                                                    <MudTd DataLabel="Quantidade" align="Align.Right">
                                                                        <MudChip T="int" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                                                            @context.Quantidade
                                                                        </MudChip>
                                                                    </MudTd>
                                                                    <MudTd DataLabel="Preço Unit." align="Align.Right">
                                                                        @context.PrecoUnitario.ToString("C")
                                                                    </MudTd>
                                                                    <MudTd DataLabel="Subtotal" align="Align.Right">
                                                                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                                                                            @context.Subtotal.ToString("C")
                                                                        </MudText>
                                                                    </MudTd>
                                                                    @if (pedido.Status == OrderStatus.Entregue)
                                                                    {
                                                                        <MudTd DataLabel="Ações" align="Align.Center">
                                                                            @if (context.JaAvaliado)
                                                                            {
                                                                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                                                                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                                                                    Avaliado
                                                                                </MudChip>
                                                                            }
                                                                            else
                                                                            {
                                                                                <MudButton Size="Size.Small" 
                                                                                          Variant="Variant.Outlined" 
                                                                                          Color="Color.Primary"
                                                                                          StartIcon="@Icons.Material.Filled.Star"
                                                                                          OnClick="@(() => AbrirModalAvaliacao(context.ProductId, context.Nome, pedido.Id))">
                                                                                    Deixar Avaliação
                                                                                </MudButton>
                                                                            }
                                                                        </MudTd>
                                                                    }
                                                                </RowTemplate>
                                                            </MudTable>
                                                            <MudDivider Class="my-3" />
                                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-3">
                                                                <MudText Typo="Typo.body1">Subtotal:</MudText>
                                                                <MudText Typo="Typo.body1">@pedido.Detalhes.Subtotal.ToString("C")</MudText>
                                                            </MudStack>
                                                            @if (pedido.Detalhes.Frete > 0)
                                                            {
                                                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                                    <MudText Typo="Typo.body1">Frete:</MudText>
                                                                    <MudText Typo="Typo.body1">@pedido.Detalhes.Frete.ToString("C")</MudText>
                                                                </MudStack>
                                                            }
                                                            <MudDivider Class="my-2" />
                                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                                <MudText Typo="Typo.h6">Total:</MudText>
                                                                <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Primary">
                                                                    @pedido.Detalhes.TotalPedido.ToString("C")
                                                                </MudText>
                                                            </MudStack>
                                                        </MudCard>
                                                    </MudItem>
                                                    <MudItem xs="12" md="4">
                                                        <MudCard Elevation="1" Class="pa-4">
                                                            <MudText Typo="Typo.h6" Class="mb-3">
                                                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                                                                Informações do Pedido
                                                            </MudText>
                                                            <MudStack Spacing="2">
                                                                <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                                                                    <MudStack>
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Data do Pedido</MudText>
                                                                        <MudText Typo="Typo.body2">@pedido.Detalhes.DataLocal</MudText>
                                                                    </MudStack>
                                                                </MudStack>
                                                                <MudDivider />
                                                                <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Color="Color.Secondary" />
                                                                    <MudStack>
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Endereço de Entrega</MudText>
                                                                        <MudText Typo="Typo.body2">
                                                                            @pedido.Detalhes.Rua, @pedido.Detalhes.Numero
                                                                            @if (!string.IsNullOrEmpty(pedido.Detalhes.Complemento))
                                                                            {
                                                                                <span> - @pedido.Detalhes.Complemento</span>
                                                                            }
                                                                            <br />
                                                                            @pedido.Detalhes.Bairro, @pedido.Detalhes.Cidade
                                                                        </MudText>
                                                                    </MudStack>
                                                                </MudStack>
                                                                <MudDivider />
                                                                <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Small" Color="Color.Secondary" />
                                                                    <MudStack>
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                                                                        <MudChip T="string" Size="Size.Medium" 
                                                                                Color="@GetStatusColor(pedido.Status)" 
                                                                                Variant="Variant.Filled"
                                                                                Icon="@GetStatusIcon(pedido.Status)">
                                                                            @pedido.StatusTexto
                                                                        </MudChip>
                                                                    </MudStack>
                                                                </MudStack>
                                                            </MudStack>
                                                        </MudCard>
                                                    </MudItem>
                                                </MudGrid>
                                            }
                                            else if (pedido.ErroDetalhes is not null)
                                            {
                                                <MudAlert Severity="Severity.Error" Class="mt-2">
                                                    <MudText Typo="Typo.body2">@pedido.ErroDetalhes</MudText>
                                                </MudAlert>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Class="text-center text-muted">Nenhum detalhe disponível</MudText>
                                            }
    </div>
}
                                </MudCardContent>
                            </MudCard>
                        }
                    </MudStack>
                }
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

<!-- Dialog para Editar/Criar Endereço -->
<MudDialog @bind-IsVisible="_showEnderecoDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_editandoEndereco?.Id == 0 ? "Novo Endereço" : "Editar Endereço")</MudText>
    </TitleContent>
    <DialogContent>
        @if (_editandoEndereco is not null)
        {
            <EditForm Model="_editandoEndereco" OnValidSubmit="SalvarEnderecoAsync">
                <DataAnnotationsValidator />
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_editandoEndereco.Rua" 
                                Label="Rua" 
                                Variant="Variant.Outlined"
                                Required="true"
                                RequiredError="Rua é obrigatória" />
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="4">
                            <MudTextField Value="@_numeroBinding" 
                                        ValueChanged="@((string value) => _numeroBinding = new string((value ?? string.Empty).Where(char.IsDigit).ToArray()))"
                                        Label="Número" 
                                        Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="8">
                            <MudTextField @bind-Value="_editandoEndereco.Bairro" 
                                        Label="Bairro" 
                                        Variant="Variant.Outlined"
                                        Required="true"
                                        RequiredError="Bairro é obrigatório" />
                        </MudItem>
                    </MudGrid>
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_editandoEndereco.Cidade" 
                                        Label="Cidade" 
                                        Variant="Variant.Outlined"
                                        Required="true"
                                        RequiredError="Cidade é obrigatória" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_editandoEndereco.Complemento" 
                                        Label="Complemento" 
                                        Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                    <MudCheckBox @bind-Value="_editandoEndereco.IsDefault" 
                               Label="Marcar como endereço padrão"
                               Color="Color.Primary" />
                </MudStack>
            </EditForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelarEndereco">Cancelar</MudButton>
        <MudButton Color="Color.Primary" 
                  Variant="Variant.Filled"
                  OnClick="SalvarEnderecoAsync"
                  Disabled="@_savingEndereco">
            @(_savingEndereco ? "Salvando..." : "Salvar")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool _loading = true;
    private bool _saving = false;
    private string? _erro;
    private int _activeTabIndex = 0;

    // Endereços
    private bool _loadingEnderecos = false;
    private bool _savingEndereco = false;
    private List<AddressDto> _enderecos = new();
    private AddressDto? _editandoEndereco;
    private bool _showEnderecoDialog = false;
    private string _numeroBinding = string.Empty;

    // Pedidos
    private bool _loadingPedidos = false;
    private string? _erroPedidos;
    private List<OrderRow> _pedidos = new();

    private PerfilModel _model = new();
    private AlterarSenhaModel _senha = new();
    private AlterarEmailModel _emailModel = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(state.User);
            if (user is null)
            {
                Nav.NavigateTo($"/account/login?returnUrl={Uri.EscapeDataString(Nav.Uri)}", forceLoad: true);
                return;
            }

            _model = new PerfilModel
            {
                Id = user.Id,
                NomeCompleto = user.NomeCompleto,
                Email = user.Email ?? string.Empty,
                DocumentoFiscal = user.DocumentoFiscal,
                DataNascimento = user.DataNascimento,
                Genero = user.Genero ?? string.Empty,
                TipoCliente = user.TipoCliente,
                Rua = user.Rua,
                Numero = user.Numero,
                Bairro = user.Bairro,
                Cidade = user.Cidade,
                Complemento = user.Complemento
            };

            _emailModel = new AlterarEmailModel
            {
                Email = user.Email ?? string.Empty
            };

            // Carrega endereços e pedidos sequencialmente para evitar conflito de DbContext
            Logger.LogInformation("Iniciando carregamento de endereços e pedidos");
            await CarregarEnderecosAsync();
            Logger.LogInformation("Endereços carregados. Iniciando carregamento de pedidos");
            await CarregarPedidosAsync();
            Logger.LogInformation("Pedidos carregados com sucesso");
        }
        catch (Exception ex)
        {
            _erro = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CarregarEnderecosAsync()
    {
        _loadingEnderecos = true;
        Logger.LogInformation("CarregarEnderecosAsync iniciado");
        try
        {
            var userId = await GetUserIdAsync();
            Logger.LogInformation("UserId obtido para endereços: {UserId}", userId ?? "NULL");
            if (string.IsNullOrWhiteSpace(userId))
            {
                Logger.LogWarning("UserId vazio ao carregar endereços");
                return;
            }

            Logger.LogInformation("Chamando AddressService.ListAsync para userId: {UserId}", userId);
            var list = await AddressService.ListAsync(userId);
            Logger.LogInformation("AddressService.ListAsync retornou {Count} endereços", list?.Count ?? 0);
            
            _enderecos = list.Select(a => new AddressDto
            {
                Id = a.Id,
                Rua = a.Rua,
                Numero = a.Numero,
                Cidade = a.Cidade,
                Bairro = a.Bairro,
                Complemento = a.Complemento,
                IsDefault = a.IsDefault
            }).ToList();
            
            Logger.LogInformation("Endereços processados: {Count}", _enderecos.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar endereços. Mensagem: {Message}, StackTrace: {StackTrace}", ex.Message, ex.StackTrace);
            Snackbar.Add($"Erro ao carregar endereços: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingEnderecos = false;
            Logger.LogInformation("CarregarEnderecosAsync finalizado. LoadingEnderecos: {Loading}", _loadingEnderecos);
            StateHasChanged();
        }
    }

    private async Task CarregarPedidosAsync()
    {
        _loadingPedidos = true;
        _erroPedidos = null;
        Logger.LogInformation("CarregarPedidosAsync iniciado");
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = state.User;
            Logger.LogInformation("AuthenticationState obtido. IsAuthenticated: {IsAuth}", user?.Identity?.IsAuthenticated ?? false);
            
            if (user?.Identity?.IsAuthenticated != true)
            {
                Logger.LogWarning("Usuário não autenticado ao carregar pedidos");
                return;
            }

            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            Logger.LogInformation("UserId obtido para pedidos: {UserId}", userId ?? "NULL");
            
            if (string.IsNullOrWhiteSpace(userId))
            {
                Logger.LogWarning("UserId vazio ao carregar pedidos");
                return;
            }

            Logger.LogInformation("Chamando OrderService.ListarPedidosPorUsuarioAsync para userId: {UserId}", userId);
            var list = await OrderService.ListarPedidosPorUsuarioAsync(userId);
            Logger.LogInformation("OrderService.ListarPedidosPorUsuarioAsync retornou {Count} pedidos", list?.Count ?? 0);

            _pedidos = list.Select(o => new OrderRow
            {
                Id = o.Id,
                DataPedidoLocal = o.DataPedido.ToLocalTime().ToString("g"),
                StatusTexto = FormatStatus(o.Status),
                TotalTexto = o.TotalPedido.ToString("C"),
                Status = o.Status
            }).ToList();
            
            Logger.LogInformation("Pedidos processados: {Count}", _pedidos.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar pedidos. Mensagem: {Message}, StackTrace: {StackTrace}", ex.Message, ex.StackTrace);
            _erroPedidos = ex.Message;
        }
        finally
        {
            _loadingPedidos = false;
            Logger.LogInformation("CarregarPedidosAsync finalizado. LoadingPedidos: {Loading}", _loadingPedidos);
            StateHasChanged();
        }
    }

    private void NovoEndereco()
    {
        _editandoEndereco = new AddressDto();
        _numeroBinding = string.Empty;
        _showEnderecoDialog = true;
    }

    private void EditarEndereco(AddressDto a)
    {
        _editandoEndereco = new AddressDto
        {
            Id = a.Id,
            Rua = a.Rua,
            Numero = a.Numero,
            Bairro = a.Bairro,
            Cidade = a.Cidade,
            Complemento = a.Complemento,
            IsDefault = a.IsDefault
        };
        _numeroBinding = a.Numero ?? string.Empty;
        _showEnderecoDialog = true;
    }

    private async Task SalvarEnderecoAsync()
    {
        if (_editandoEndereco is null) return;

        _savingEndereco = true;
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                Snackbar.Add("Erro de autenticação", Severity.Error);
                return;
            }

            _editandoEndereco.Numero = string.IsNullOrEmpty(_numeroBinding) ? null : _numeroBinding;

            var entity = new Address
            {
                Rua = _editandoEndereco.Rua,
                Numero = _editandoEndereco.Numero,
                Bairro = _editandoEndereco.Bairro,
                Cidade = _editandoEndereco.Cidade,
                Complemento = _editandoEndereco.Complemento,
                IsDefault = _editandoEndereco.IsDefault
            };

            if (_editandoEndereco.Id == 0)
            {
                await AddressService.CreateAsync(userId, entity);
                Snackbar.Add("Endereço cadastrado com sucesso!", Severity.Success);
            }
            else
            {
                await AddressService.UpdateAsync(userId, _editandoEndereco.Id, entity);
                Snackbar.Add("Endereço atualizado com sucesso!", Severity.Success);
            }

            _showEnderecoDialog = false;
            _editandoEndereco = null;
            await CarregarEnderecosAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao salvar endereço: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingEndereco = false;
            StateHasChanged();
        }
    }

    private async Task ExcluirEndereco(AddressDto a)
    {
        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true
        };
        
        var result = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            $"Tem certeza que deseja excluir o endereço?\n\n{FormatEndereco(a)}",
            yesText: "Excluir",
            cancelText: "Cancelar",
            options: options);

        if (result == true)
        {
            try
            {
                var userId = await GetUserIdAsync();
                if (string.IsNullOrWhiteSpace(userId))
                {
                    Snackbar.Add("Erro de autenticação", Severity.Error);
                    return;
                }

                await AddressService.DeleteAsync(userId, a.Id);
                Snackbar.Add("Endereço excluído com sucesso!", Severity.Success);
                await CarregarEnderecosAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir endereço: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task TornarPadraoEndereco(AddressDto a)
    {
        try
        {
            var userId = await GetUserIdAsync();
            if (string.IsNullOrWhiteSpace(userId))
            {
                Snackbar.Add("Erro de autenticação", Severity.Error);
                return;
            }

            await AddressService.MakeDefaultAsync(userId, a.Id);
            Snackbar.Add("Endereço definido como padrão!", Severity.Success);
            await CarregarEnderecosAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao definir endereço padrão: {ex.Message}", Severity.Error);
        }
    }

    private void CancelarEndereco()
    {
        _editandoEndereco = null;
        _showEnderecoDialog = false;
    }

    private async Task TogglePedido(OrderRow pedido)
    {
        pedido.IsExpanded = !pedido.IsExpanded;
        
        if (pedido.IsExpanded)
        {
            if (pedido.Detalhes is null && !pedido.CarregandoDetalhes)
            {
                pedido.CarregandoDetalhes = true;
                await InvokeAsync(StateHasChanged);
                
                await CarregarDetalhesAsync(pedido);
            }
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task CarregarDetalhesAsync(OrderRow pedido)
    {
        pedido.ErroDetalhes = null;
        Logger.LogInformation("CarregarDetalhesAsync iniciado para pedido {PedidoId}", pedido.Id);

        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = state.User;
            var userId = user?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            Logger.LogInformation("UserId obtido para detalhes do pedido {PedidoId}: {UserId}", pedido.Id, userId ?? "NULL");

            if (string.IsNullOrEmpty(userId))
            {
                Logger.LogWarning("UserId vazio ao carregar detalhes do pedido {PedidoId}", pedido.Id);
                pedido.ErroDetalhes = "Usuário não autenticado.";
                return;
            }

            Logger.LogInformation("Chamando OrderService.ObterPorIdAsync para pedido {PedidoId}", pedido.Id);
            var order = await OrderService.ObterPorIdAsync(pedido.Id);
            Logger.LogInformation("OrderService.ObterPorIdAsync retornou para pedido {PedidoId}. Order é null: {IsNull}", pedido.Id, order is null);

            if (order is not null && order.ApplicationUserId == userId)
            {
                Logger.LogInformation("Processando detalhes do pedido {PedidoId}. Itens: {ItemCount}", pedido.Id, order.Itens?.Count ?? 0);
                pedido.Detalhes = new OrderDetails
                {
                    DataLocal = order.DataPedido.ToLocalTime().ToString("g"),
                    Rua = order.Rua,
                    Numero = order.Numero ?? string.Empty,
                    Bairro = order.Bairro,
                    Cidade = order.Cidade,
                    Complemento = order.Complemento ?? string.Empty,
                    TotalPedido = order.TotalPedido,
                    Itens = (order.Itens ?? Enumerable.Empty<OrderItem>()).Select(i => new OrderItemDetail
                    {
                        Nome = i.Product?.Nome ?? $"Produto {i.ProductId}",
                        Quantidade = i.Quantidade,
                        PrecoUnitario = i.PrecoUnitario,
                        Subtotal = i.PrecoUnitario * i.Quantidade,
                        ImagemUrl = i.Product?.ImagemUrl,
                        ProductId = i.ProductId
                    }).ToList()
                };
                pedido.Detalhes.Subtotal = pedido.Detalhes.Itens.Sum(i => i.Subtotal);
                pedido.Detalhes.Frete = pedido.Detalhes.TotalPedido - pedido.Detalhes.Subtotal;
                
                // Verificar quais produtos já foram avaliados neste pedido específico
                if (pedido.Status == OrderStatus.Entregue)
                {
                    foreach (var item in pedido.Detalhes.Itens)
                    {
                        item.JaAvaliado = await ReviewService.UsuarioJaAvaliouNoPedidoAsync(userId!, item.ProductId, pedido.Id);
                    }
                }
                
                Logger.LogInformation("Detalhes do pedido {PedidoId} processados com sucesso", pedido.Id);
            }
            else
            {
                Logger.LogWarning("Pedido {PedidoId} não encontrado ou não pertence ao userId {UserId}", pedido.Id, userId);
                pedido.ErroDetalhes = "Pedido não encontrado ou não pertence a você.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar detalhes do pedido {PedidoId}. Mensagem: {Message}, StackTrace: {StackTrace}", pedido.Id, ex.Message, ex.StackTrace);
            pedido.ErroDetalhes = $"Erro ao carregar detalhes: {ex.Message}";
        }
        finally
        {
            pedido.CarregandoDetalhes = false;
            Logger.LogInformation("CarregarDetalhesAsync finalizado para pedido {PedidoId}. CarregandoDetalhes: {Loading}", pedido.Id, pedido.CarregandoDetalhes);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task<string> GetUserIdAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            return user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
        }
        return string.Empty;
    }

    private async Task AbrirModalAvaliacao(int productId, string productName, int orderId)
    {
        var userId = await GetUserIdAsync();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Snackbar.Add("Você precisa estar logado para avaliar um produto.", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<ReviewDialog>
        {
            { x => x.ProductId, productId },
            { x => x.ProductName, productName },
            { x => x.UserId, userId },
            { x => x.OrderId, orderId }
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ReviewDialog>("Avaliar Produto", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // Recarregar detalhes do pedido para atualizar status de avaliação
            var pedido = _pedidos.FirstOrDefault(p => p.IsExpanded);
            if (pedido != null)
            {
                await CarregarDetalhesAsync(pedido);
            }
            Snackbar.Add("Avaliação salva com sucesso!", Severity.Success);
        }
    }

    private static string FormatEndereco(AddressDto a)
        => $"{a.Rua}, {a.Numero} - {a.Bairro}, {a.Cidade} {a.Complemento}";

    private static string FormatStatus(OrderStatus status) => status switch
    {
        OrderStatus.Processando => "Processando",
        OrderStatus.Confirmado => "Confirmado",
        OrderStatus.EmPreparacao => "Em preparação",
        OrderStatus.Enviado => "Enviado",
        OrderStatus.Entregue => "Entregue",
        OrderStatus.Cancelado => "Cancelado",
        _ => status.ToString()
    };

    private static Color GetStatusColor(OrderStatus status) => status switch
    {
        OrderStatus.Processando => Color.Info,
        OrderStatus.Confirmado => Color.Success,
        OrderStatus.EmPreparacao => Color.Warning,
        OrderStatus.Enviado => Color.Primary,
        OrderStatus.Entregue => Color.Success,
        OrderStatus.Cancelado => Color.Error,
        _ => Color.Default
    };

    private static string GetStatusIcon(OrderStatus status) => status switch
    {
        OrderStatus.Processando => Icons.Material.Filled.HourglassEmpty,
        OrderStatus.Confirmado => Icons.Material.Filled.CheckCircle,
        OrderStatus.EmPreparacao => Icons.Material.Filled.Restaurant,
        OrderStatus.Enviado => Icons.Material.Filled.LocalShipping,
        OrderStatus.Entregue => Icons.Material.Filled.DoneAll,
        OrderStatus.Cancelado => Icons.Material.Filled.Cancel,
        _ => Icons.Material.Filled.Info
    };

    private async Task AtualizarEmailAsync()
    {
        _erro = null;
        _saving = true;
        StateHasChanged();

        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(state.User);
            if (user is null)
            {
                _erro = "Sessão expirada.";
                Snackbar.Add("Sessão expirada. Por favor, faça login novamente.", Severity.Error);
                return;
            }

            if (user.Email == _emailModel.Email)
            {
                Snackbar.Add("O e-mail informado é o mesmo já cadastrado.", Severity.Info);
                return;
            }

            user.Email = _emailModel.Email;
            user.UserName = _emailModel.Email;
            user.NormalizedEmail = _emailModel.Email.ToUpperInvariant();
            user.NormalizedUserName = _emailModel.Email.ToUpperInvariant();

            var result = await UserManager.UpdateAsync(user);
            if (!result.Succeeded)
            {
                _erro = string.Join(" ", result.Errors.Select(e => e.Description));
                Snackbar.Add(_erro, Severity.Error);
                return;
            }

            _model.Email = _emailModel.Email;
            Snackbar.Add("E-mail atualizado com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            _erro = ex.Message;
            Snackbar.Add($"Erro ao atualizar e-mail: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private async Task AlterarSenhaAsync()
    {
        _erro = null;
        _saving = true;
        StateHasChanged();

        try
        {
            if (_senha.NovaSenha != _senha.ConfirmacaoSenha)
            {
                _erro = "Confirmação de senha não confere.";
                Snackbar.Add(_erro, Severity.Error);
                return;
            }

            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(state.User);
            if (user is null)
            {
                _erro = "Sessão expirada.";
                Snackbar.Add("Sessão expirada. Por favor, faça login novamente.", Severity.Error);
                return;
            }

            var result = await UserManager.ChangePasswordAsync(user, _senha.SenhaAtual, _senha.NovaSenha);
            if (!result.Succeeded)
            {
                _erro = string.Join(" ", result.Errors.Select(e => e.Description));
                Snackbar.Add(_erro, Severity.Error);
                return;
            }

            _senha = new();
            Snackbar.Add("Senha alterada com sucesso!", Severity.Success);
        }
        catch (Exception ex)
        {
            _erro = ex.Message;
            Snackbar.Add($"Erro ao alterar senha: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private sealed class PerfilModel
    {
        public string Id { get; set; } = string.Empty;
        public string NomeCompleto { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string DocumentoFiscal { get; set; } = string.Empty;
        public DateTime DataNascimento { get; set; }
        public string Genero { get; set; } = string.Empty;
        public string TipoCliente { get; set; } = string.Empty;
        public string Rua { get; set; } = string.Empty;
        public string? Numero { get; set; }
        public string Bairro { get; set; } = string.Empty;
        public string Cidade { get; set; } = string.Empty;
        public string? Complemento { get; set; }
    }

    private sealed class AlterarSenhaModel
    {
        [Required(ErrorMessage = "Senha atual é obrigatória")]
        public string SenhaAtual { get; set; } = string.Empty;
        
        [Required(ErrorMessage = "Nova senha é obrigatória")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "A senha deve ter no mínimo 8 caracteres")]
        public string NovaSenha { get; set; } = string.Empty;
        
        [Required(ErrorMessage = "Confirmação de senha é obrigatória")]
        public string ConfirmacaoSenha { get; set; } = string.Empty;
    }

    private sealed class AlterarEmailModel
    {
        [Required(ErrorMessage = "E-mail é obrigatório")]
        [EmailAddress(ErrorMessage = "E-mail inválido")]
        public string Email { get; set; } = string.Empty;
    }

    private sealed class AddressDto
    {
        public int Id { get; set; }
        [Required(ErrorMessage = "Rua é obrigatória")]
        public string Rua { get; set; } = string.Empty;
        public string? Numero { get; set; }
        [Required(ErrorMessage = "Bairro é obrigatório")]
        public string Bairro { get; set; } = string.Empty;
        [Required(ErrorMessage = "Cidade é obrigatória")]
        public string Cidade { get; set; } = string.Empty;
        public string? Complemento { get; set; }
        public bool IsDefault { get; set; }
    }

    private sealed class OrderRow
    {
        public int Id { get; set; }
        public string DataPedidoLocal { get; set; } = string.Empty;
        public string StatusTexto { get; set; } = string.Empty;
        public string TotalTexto { get; set; } = string.Empty;
        public OrderStatus Status { get; set; }
        public bool IsExpanded { get; set; }
        public bool CarregandoDetalhes { get; set; }
        public OrderDetails? Detalhes { get; set; }
        public string? ErroDetalhes { get; set; }
    }

    private sealed class OrderDetails
    {
        public string DataLocal { get; set; } = string.Empty;
        public string Rua { get; set; } = string.Empty;
        public string Numero { get; set; } = string.Empty;
        public string Bairro { get; set; } = string.Empty;
        public string Cidade { get; set; } = string.Empty;
        public string Complemento { get; set; } = string.Empty;
        public decimal TotalPedido { get; set; }
        public decimal Subtotal { get; set; }
        public decimal Frete { get; set; }
        public List<OrderItemDetail> Itens { get; set; } = new();
    }

    private sealed class OrderItemDetail
    {
        public string Nome { get; set; } = string.Empty;
        public int Quantidade { get; set; }
        public decimal PrecoUnitario { get; set; }
        public decimal Subtotal { get; set; }
        public string? ImagemUrl { get; set; }
        public int ProductId { get; set; }
        public bool JaAvaliado { get; set; }
    }

    private string DataNascimentoFormatada => _model.DataNascimento.ToString("dd/MM/yyyy");
}
