@page "/account/orders"
@attribute [Authorize]
@using MudBlazor
@inject IOrderService OrderService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject ILogger<Orders> Logger
@implements IAsyncDisposable

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Meus Pedidos</MudText>

@if (_loading)
{
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
        <MudText Typo="Typo.body1" Class="text-center">Carregando seus pedidos...</MudText>
}
else if (_erro is not null)
{
        <MudAlert Severity="Severity.Error" Class="mb-4">
            <MudText Typo="Typo.body1">@_erro</MudText>
        </MudAlert>
}
else if (_pedidos.Count == 0)
{
        <MudPaper Elevation="2" Class="pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Filled.ShoppingBag" Size="Size.Large" Color="Color.Default" Class="mb-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Você ainda não realizou nenhum pedido</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Quando você fizer um pedido, ele aparecerá aqui.
            </MudText>
            <MudButton variant="Variant.Filled" Color="Color.Primary" Href="/" Class="mt-4">
                <MudIcon Icon="@Icons.Material.Filled.Store" Class="mr-2" />
                Ir para a loja
            </MudButton>
        </MudPaper>
}
else
{
        <MudStack Spacing="3">
            @foreach (var pedido in _pedidos)
            {
                <MudCard Elevation="2" Class="mb-4">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Class="mb-2">
                            <MudText Typo="Typo.h6" Class="mb-0">Pedido #@pedido.Id</MudText>
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(pedido.Status)" variant="Variant.Filled">
                                @pedido.StatusTexto
                            </MudChip>
                            <MudSpacer />
                            <MudText Typo="Typo.body1" Class="mb-0 font-weight-bold">
                                @pedido.TotalTexto
                            </MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@pedido.DataPedidoLocal</MudText>
                            <MudSpacer />
                            <MudButton Size="Size.Small" 
                                      variant="Variant.Text" 
                                      Color="Color.Primary"
                                      onClick="@(() => TogglePedido(pedido))"
                                      EndIcon="@(pedido.IsExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)">
                                @(pedido.IsExpanded ? "Ocultar" : "Ver") detalhes
                            </MudButton>
                        </MudStack>
                        
                        @if (pedido.IsExpanded)
                        {
                            <div class="mt-4">
                                @if (pedido.CarregandoDetalhes || (pedido.Detalhes is null && pedido.ErroDetalhes is null))
                                {
                                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                                    <MudText Typo="Typo.body2" Class="text-center">Carregando detalhes...</MudText>
                                }
                                else if (pedido.Detalhes is not null)
                                {
                                    <MudGrid Spacing="3" Class="mt-2">
                                            <MudItem xs="12" md="8">
                                                <MudCard Elevation="1" Class="pa-4">
                                                <MudText Typo="Typo.h6" Class="mb-3">
                                                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Small" Class="mr-2" />
                                                    Itens do Pedido
                                                </MudText>
                                                <MudTable Items="@pedido.Detalhes.Itens" Hover="true" Dense="true" Striped="true">
                                                    <HeaderContent>
                                                        <MudTh>Produto</MudTh>
                                                        <MudTh align="Align.Right">Quantidade</MudTh>
                                                        <MudTh align="Align.Right">Preço Unit.</MudTh>
                                                        <MudTh align="Align.Right">Subtotal</MudTh>
                                                    </HeaderContent>
                                                    <RowTemplate>
                                                        <MudTd DataLabel="Produto">
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                @if (!string.IsNullOrEmpty(context.ImagemUrl))
                                                                {
                                                                    <MudAvatar Size="Size.Small" Style="width: 40px; height: 40px;">
                                                                        <img src="@context.ImagemUrl" alt="@context.Nome" style="width: 100%; height: 100%; object-fit: cover;" />
                                                                    </MudAvatar>
                                                                }
                                                                <MudText Typo="Typo.body2">@context.Nome</MudText>
                                                            </MudStack>
                                                        </MudTd>
                                                        <MudTd DataLabel="Quantidade" align="Align.Right">
                                                            <MudChip T="int" Size="Size.Small" Color="Color.Primary" variant="Variant.Filled">
                                                                @context.Quantidade
                                                            </MudChip>
                                                        </MudTd>
                                                        <MudTd DataLabel="Preço Unit." align="Align.Right">
                                                            @context.PrecoUnitario.ToString("C")
                                                        </MudTd>
                                                        <MudTd DataLabel="Subtotal" align="Align.Right">
                                                            <MudText Typo="Typo.body2" Class="font-weight-bold">
                                                                @context.Subtotal.ToString("C")
                                                            </MudText>
                                                        </MudTd>
                                                    </RowTemplate>
                                                </MudTable>
                                                <MudDivider Class="my-3" />
                                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-3">
                                                    <MudText Typo="Typo.body1">Subtotal:</MudText>
                                                    <MudText Typo="Typo.body1">@pedido.Detalhes.Subtotal.ToString("C")</MudText>
                                                </MudStack>
                                                @if (pedido.Detalhes.Frete > 0)
                                                {
                                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                        <MudText Typo="Typo.body1">Frete:</MudText>
                                                        <MudText Typo="Typo.body1">@pedido.Detalhes.Frete.ToString("C")</MudText>
                                                    </MudStack>
                                                }
                                                <MudDivider Class="my-2" />
                                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.h6">Total:</MudText>
                                                    <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Primary">
                                                        @pedido.Detalhes.TotalPedido.ToString("C")
                                                    </MudText>
                                                </MudStack>
                                            </MudCard>
                                        </MudItem>
                                        <MudItem xs="12" md="4">
                                            <MudCard Elevation="1" Class="pa-4">
                                                <MudText Typo="Typo.h6" Class="mb-3">
                                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                                                    Informações do Pedido
                                                </MudText>
                                                <MudStack Spacing="2">
                                                    <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                                                        <MudStack>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Data do Pedido</MudText>
                                                            <MudText Typo="Typo.body2">@pedido.Detalhes.DataLocal</MudText>
                                                        </MudStack>
                                                    </MudStack>
                                                    <MudDivider />
                                                    <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Color="Color.Secondary" />
                                                        <MudStack>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Endereço de Entrega</MudText>
                                                            <MudText Typo="Typo.body2">
                                                                @pedido.Detalhes.Rua, @pedido.Detalhes.Numero
                                                                @if (!string.IsNullOrEmpty(pedido.Detalhes.Complemento))
                                                                {
                                                                    <span> - @pedido.Detalhes.Complemento</span>
                                                                }
                                                                <br />
                                                                @pedido.Detalhes.Bairro, @pedido.Detalhes.Cidade
                                                            </MudText>
                                                        </MudStack>
                                                    </MudStack>
                                                    <MudDivider />
                                                    <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Small" Color="Color.Secondary" />
                                                        <MudStack>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                                                            <MudChip T="string" Size="Size.Medium" 
                                                                    Color="@GetStatusColor(pedido.Status)" 
                                                                    variant="Variant.Filled"
                                                                    Icon="@GetStatusIcon(pedido.Status)">
                                                                @pedido.StatusTexto
                                                            </MudChip>
                                                        </MudStack>
                                                    </MudStack>
                                                </MudStack>
                                                </MudCard>
                                            </MudItem>
                                        </MudGrid>
            }
                                    else if (pedido.ErroDetalhes is not null)
                                    {
                                        <MudAlert Severity="Severity.Error" Class="mt-2">
                                            <MudText Typo="Typo.body2">@pedido.ErroDetalhes</MudText>
                                        </MudAlert>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Class="text-center text-muted">Nenhum detalhe disponível</MudText>
}
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            }
        </MudStack>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private string? _erro;
    private IReadOnlyList<OrderRow> _pedidos = Array.Empty<OrderRow>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = state.User;
            if (user?.Identity?.IsAuthenticated != true)
            {
                Nav.NavigateTo($"/account/login?returnUrl={Uri.EscapeDataString(Nav.Uri)}", forceLoad: true);
                return;
            }

            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var list = await OrderService.ListarPedidosPorUsuarioAsync(userId!);

            _pedidos = list.Select(o => new OrderRow
            {
                Id = o.Id,
                DataPedidoLocal = o.DataPedido.ToLocalTime().ToString("g"),
                StatusTexto = FormatStatus(o.Status),
                TotalTexto = o.TotalPedido.ToString("C"),
                Status = o.Status
            }).ToList();
        }
        catch (Exception ex)
        {
            _erro = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task TogglePedido(OrderRow pedido)
    {
        Logger.LogInformation("TogglePedido: Pedido #{PedidoId}, Current IsExpanded: {CurrentExpanded}", 
            pedido.Id, pedido.IsExpanded);
        
        pedido.IsExpanded = !pedido.IsExpanded;
        Logger.LogInformation("Estado do pedido #{PedidoId} alterado para: {IsExpanded}", pedido.Id, pedido.IsExpanded);
        
        if (pedido.IsExpanded)
        {
            Logger.LogInformation("Pedido #{PedidoId} expandido. Detalhes: {DetalhesNull}, Carregando: {Carregando}", 
                pedido.Id, pedido.Detalhes is null, pedido.CarregandoDetalhes);
            
            if (pedido.Detalhes is null && !pedido.CarregandoDetalhes)
            {
                Logger.LogInformation("Iniciando carregamento de detalhes para pedido #{PedidoId}", pedido.Id);
                // Inicia o carregamento imediatamente
                pedido.CarregandoDetalhes = true;
                await InvokeAsync(StateHasChanged);
                
                await CarregarDetalhesAsync(pedido);
            }
            else
            {
                Logger.LogInformation("Pedido #{PedidoId} já tem detalhes ou está carregando. DetalhesNull: {DetalhesNull}, ItensCount: {ItensCount}", 
                    pedido.Id, pedido.Detalhes is null, pedido.Detalhes?.Itens?.Count ?? -1);
                // Força atualização mesmo que já tenha detalhes
                await InvokeAsync(StateHasChanged);
            }
        }
        else
        {
            Logger.LogInformation("Pedido #{PedidoId} colapsado", pedido.Id);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task CarregarDetalhesAsync(OrderRow pedido)
    {
        Logger.LogInformation("CarregarDetalhesAsync iniciado para pedido #{PedidoId}", pedido.Id);
        pedido.ErroDetalhes = null;

        try
        {
            // Verifica autenticação
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = state.User;
            var userId = user?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            Logger.LogInformation("UserId obtido: {UserId} (IsNull: {IsNull})", 
                userId ?? "NULL", string.IsNullOrEmpty(userId));

            if (string.IsNullOrEmpty(userId))
            {
                Logger.LogWarning("Usuário não autenticado ao tentar carregar pedido #{PedidoId}", pedido.Id);
                pedido.ErroDetalhes = "Usuário não autenticado.";
                return;
            }

            // Usa o OrderService diretamente ao invés de HTTP para garantir autenticação
            Logger.LogInformation("Buscando pedido #{PedidoId} no OrderService", pedido.Id);
            var order = await OrderService.ObterPorIdAsync(pedido.Id);

            Logger.LogInformation("OrderService retornou: {IsNull} (OrderId: {OrderId}, UserId: {OrderUserId})", 
                order is null ? "NULL" : "NOT NULL",
                order?.Id ?? -1,
                order?.ApplicationUserId ?? "NULL");

            // Verifica se o pedido pertence ao usuário atual
            if (order is not null)
            {
                Logger.LogInformation("Pedido encontrado. Verificando propriedade: OrderUserId={OrderUserId}, CurrentUserId={CurrentUserId}, Match={Match}",
                    order.ApplicationUserId, userId, order.ApplicationUserId == userId);

                if (order.ApplicationUserId == userId)
                {
                    Logger.LogInformation("Pedido #{PedidoId} pertence ao usuário. Itens: {ItemCount}", 
                        pedido.Id, order.Itens?.Count ?? 0);

                    pedido.Detalhes = new OrderDetails
                    {
                        DataLocal = order.DataPedido.ToLocalTime().ToString("g"),
                        Rua = order.Rua,
                        Numero = order.Numero ?? string.Empty,
                        Bairro = order.Bairro,
                        Cidade = order.Cidade,
                        Complemento = order.Complemento ?? string.Empty,
                        TotalPedido = order.TotalPedido,
                        Itens = (order.Itens ?? Enumerable.Empty<OrderItem>()).Select(i => new OrderItemDetail
                        {
                            Nome = i.Product?.Nome ?? $"Produto {i.ProductId}",
                            Quantidade = i.Quantidade,
                            PrecoUnitario = i.PrecoUnitario,
                            Subtotal = i.PrecoUnitario * i.Quantidade,
                            ImagemUrl = i.Product?.ImagemUrl
                        }).ToList()
                    };
                    
                    Logger.LogInformation("RENDERIZANDO DETALHES para pedido #{PedidoId}. Itens: {ItemCount}", 
                        pedido.Id, pedido.Detalhes.Itens?.Count ?? 0);
                    pedido.Detalhes.Subtotal = pedido.Detalhes.Itens?.Sum(i => i.Subtotal) ?? 0m;
                    pedido.Detalhes.Frete = pedido.Detalhes.TotalPedido - pedido.Detalhes.Subtotal;

                    Logger.LogInformation("Detalhes do pedido #{PedidoId} carregados com sucesso. Itens: {ItemCount}, Total: {Total}, DetalhesNotNull: {DetalhesNotNull}",
                        pedido.Id, pedido.Detalhes?.Itens?.Count ?? 0, pedido.Detalhes?.TotalPedido ?? 0, pedido.Detalhes is not null);
                    
                    // Força atualização imediata
                    await InvokeAsync(StateHasChanged);
                }
                else
                {
                    Logger.LogWarning("Pedido #{PedidoId} não pertence ao usuário {UserId}. OrderUserId: {OrderUserId}",
                        pedido.Id, userId, order.ApplicationUserId);
                    pedido.ErroDetalhes = $"Pedido não pertence a você. (OrderUserId: {order.ApplicationUserId}, YourUserId: {userId})";
                }
            }
            else
            {
                Logger.LogWarning("Pedido #{PedidoId} não encontrado no banco de dados", pedido.Id);
                pedido.ErroDetalhes = "Pedido não encontrado.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao carregar detalhes do pedido #{PedidoId}", pedido.Id);
            pedido.ErroDetalhes = $"Erro ao carregar detalhes: {ex.Message}";
        }
        finally
        {
            pedido.CarregandoDetalhes = false;
            Logger.LogInformation("CarregarDetalhesAsync finalizado para pedido #{PedidoId}. CarregandoDetalhes: {Carregando}, Detalhes: {DetalhesNull}, DetalhesItensCount: {ItensCount}, Erro: {Erro}",
                pedido.Id, pedido.CarregandoDetalhes, pedido.Detalhes is null, pedido.Detalhes?.Itens?.Count ?? -1, pedido.ErroDetalhes ?? "NULL");
            
            // Força atualização após um pequeno delay para garantir que o estado foi atualizado
            await Task.Delay(10);
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string FormatStatus(OrderStatus status) => status switch
    {
        OrderStatus.Processando => "Processando",
        OrderStatus.Confirmado => "Confirmado",
        OrderStatus.EmPreparacao => "Em preparação",
        OrderStatus.Enviado => "Enviado",
        OrderStatus.Entregue => "Entregue",
        OrderStatus.Cancelado => "Cancelado",
        _ => status.ToString()
    };

    private static Color GetStatusColor(OrderStatus status) => status switch
    {
        OrderStatus.Processando => Color.Info,
        OrderStatus.Confirmado => Color.Success,
        OrderStatus.EmPreparacao => Color.Warning,
        OrderStatus.Enviado => Color.Primary,
        OrderStatus.Entregue => Color.Success,
        OrderStatus.Cancelado => Color.Error,
        _ => Color.Default
    };

    private static string GetStatusIcon(OrderStatus status) => status switch
    {
        OrderStatus.Processando => Icons.Material.Filled.HourglassEmpty,
        OrderStatus.Confirmado => Icons.Material.Filled.CheckCircle,
        OrderStatus.EmPreparacao => Icons.Material.Filled.Restaurant,
        OrderStatus.Enviado => Icons.Material.Filled.LocalShipping,
        OrderStatus.Entregue => Icons.Material.Filled.DoneAll,
        OrderStatus.Cancelado => Icons.Material.Filled.Cancel,
        _ => Icons.Material.Filled.Info
    };

    private sealed class OrderRow
    {
        public int Id { get; set; }
        public string DataPedidoLocal { get; set; } = string.Empty;
        public string StatusTexto { get; set; } = string.Empty;
        public string TotalTexto { get; set; } = string.Empty;
        public OrderStatus Status { get; set; }
        public bool IsExpanded { get; set; }
        public bool CarregandoDetalhes { get; set; }
        public OrderDetails? Detalhes { get; set; }
        public string? ErroDetalhes { get; set; }
    }

    private sealed class OrderDetails
    {
        public string DataLocal { get; set; } = string.Empty;
        public string Rua { get; set; } = string.Empty;
        public string Numero { get; set; } = string.Empty;
        public string Bairro { get; set; } = string.Empty;
        public string Cidade { get; set; } = string.Empty;
        public string Complemento { get; set; } = string.Empty;
        public decimal TotalPedido { get; set; }
        public decimal Subtotal { get; set; }
        public decimal Frete { get; set; }
        public List<OrderItemDetail> Itens { get; set; } = new();
    }

    private sealed class OrderItemDetail
    {
        public string Nome { get; set; } = string.Empty;
        public int Quantidade { get; set; }
        public decimal PrecoUnitario { get; set; }
        public decimal Subtotal { get; set; }
        public string? ImagemUrl { get; set; }
    }

    public ValueTask DisposeAsync()
    {
        // Cleanup se necessário
        return ValueTask.CompletedTask;
    }
}


