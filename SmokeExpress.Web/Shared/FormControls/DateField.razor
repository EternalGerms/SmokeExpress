@namespace SmokeExpress.Web.Shared.FormControls

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System;
@using System.Collections.Generic;
@using System.Threading.Tasks
@using System.Globalization

@inherits FormInputBase<DateTime?>

<FormField Label="@Label"
           InputId="@ResolvedInputId"
           Hint="@Hint"
           CssClass="@CssClass"
           IsInvalid="@IsInvalid">
    <ChildContent>
        <div class="se-date-input-wrapper">
            <InputDate TValue="DateTime?"
                       id="@ResolvedInputId"
                       name="@ResolvedName"
                       class="se-input se-date-input"
                       Value="@CurrentValue"
                       ValueChanged="HandleValueChangedAsync"
                       ValueExpression="@ValueExpression"
                       format-value="@DateFormat"
                       placeholder="dd/mm/aaaa"
                       @attributes="AdditionalAttributes" />
            <label for="@ResolvedInputId" class="se-date-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
            </label>
        </div>
    </ChildContent>

    <Validation>
        @if (EditContext is not null && ValueExpression is not null)
        {
            <ValidationMessage For="ValueExpression" />
        }
        else if (!string.IsNullOrEmpty(CurrentError))
        {
            <span class="validation-message">@CurrentError</span>
        }
    </Validation>
</FormField>

@code
{
    [Parameter]
    public DateTime? Value { get; set; }

    [Parameter]
    public EventCallback<DateTime?> ValueChanged { get; set; }
        = default;

    [Parameter]
    public string DateFormat { get; set; } = "dd/MM/yyyy";

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
        = null;

    private DateTime? CurrentValue { get; set; }

    private string? ResolvedName => AdditionalAttributes is not null && AdditionalAttributes.ContainsKey("name")
        ? null
        : ResolvedInputId;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        CurrentValue = Value;
    }

    private async Task HandleValueChangedAsync(DateTime? newValue)
    {
        CurrentValue = newValue;

        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(newValue);
        }

        NotifyFieldChanged();
    }
}

