@namespace SmokeExpress.Web.Shared.FormControls

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System;
@using System.Collections.Generic;
@using System.Threading.Tasks

@inherits FormInputBase<string?>

<FormField Label="@Label"
           InputId="@ResolvedInputId"
           Hint="@Hint"
           CssClass="@CssClass"
           IsInvalid="@IsInvalid">
    <ChildContent>
        <InputSelect TValue="string?"
                     id="@ResolvedInputId"
                     name="@ResolvedName"
                     class="se-input se-select"
                     Value="@CurrentValue"
                     ValueChanged="HandleValueChangedAsync"
                     ValueExpression="@ValueExpression"
                     @attributes="AdditionalAttributes">
            @if (Options is not null)
            {
                @Options
            }
        </InputSelect>
    </ChildContent>

    <Validation>
        @if (EditContext is not null && ValueExpression is not null)
        {
            <ValidationMessage For="ValueExpression" />
        }
        else if (!string.IsNullOrEmpty(CurrentError))
        {
            <span class="validation-message">@CurrentError</span>
        }
    </Validation>
</FormField>

@code
{
    [Parameter]
    public string? Value { get; set; }
        = string.Empty;

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }
        = default;

    [Parameter]
    public RenderFragment? Options { get; set; }
        = null;

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
        = null;

    private string? CurrentValue { get; set; }
        = string.Empty;

    private string? ResolvedName => AdditionalAttributes is not null && AdditionalAttributes.ContainsKey("name")
        ? null
        : ResolvedInputId;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        CurrentValue = Value;
    }

    private async Task HandleValueChangedAsync(string? newValue)
    {
        CurrentValue = newValue;

        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(newValue);
        }

        NotifyFieldChanged();
    }
}

