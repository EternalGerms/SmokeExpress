@namespace SmokeExpress.Web.Shared.FormControls

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Collections.Generic
@using System.Threading.Tasks

@inherits FormInputBase<string?>

<FormField Label="@Label"
           InputId="@ResolvedInputId"
           Hint="@Hint"
           CssClass="@CssClass">
    <ChildContent>
        <input id="@ResolvedInputId"
               name="@InputName"
               class="se-input"
               type="@CurrentInputType"
               value="@CurrentValue"
               placeholder="@Placeholder"
               autocomplete="@AutoComplete"
               @oninput="HandleInput"
               @onblur="HandleBlur"
               @attributes="AdditionalAttributes" />
    </ChildContent>

    <Suffix>
        <button type="button"
                class="se-password-toggle"
                @onclick="TogglePassword"
                aria-label="@ToggleLabel"
                aria-pressed="@(ShowPassword ? "true" : "false")"
                title="@ToggleLabel">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 15.5C13.933 15.5 15.5 13.933 15.5 12C15.5 10.067 13.933 8.5 12 8.5C10.067 8.5 8.5 10.067 8.5 12C8.5 13.933 10.067 15.5 12 15.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                @if (ShowPassword)
                {
                    <path d="M4 4L20 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                }
            </svg>
        </button>

        @if (TrailingContent is not null)
        {
            @TrailingContent
        }
    </Suffix>

    <Validation>
        @if (EditContext is not null && ValueExpression is not null)
        {
            <ValidationMessage For="ValueExpression" />
        }
        else if (!string.IsNullOrEmpty(CurrentError))
        {
            <span class="validation-message">@CurrentError</span>
        }
    </Validation>
</FormField>

@code
{
    [Parameter]
    public string? Placeholder { get; set; }
        = null;

    [Parameter]
    public string AutoComplete { get; set; }
        = "current-password";

    [Parameter]
    public string? Value { get; set; }
        = string.Empty;

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }
        = default;

    [Parameter]
    public string ShowPasswordLabel { get; set; }
        = "Mostrar senha digitada";

    [Parameter]
    public string HidePasswordLabel { get; set; }
        = "Ocultar senha digitada";

    [Parameter]
    public RenderFragment? TrailingContent { get; set; }
        = null;

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
        = null;

    private string CurrentValue { get; set; }
        = string.Empty;

    private bool ShowPassword { get; set; }
        = false;

    private string CurrentInputType => ShowPassword ? "text" : "password";

    private string ToggleLabel => ShowPassword ? HidePasswordLabel : ShowPasswordLabel;

    private string? InputName => AdditionalAttributes is not null && AdditionalAttributes.TryGetValue("name", out var nameValue)
        ? Convert.ToString(nameValue)
        : ResolvedInputId;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        CurrentValue = Value ?? string.Empty;
    }

    private async Task HandleInput(ChangeEventArgs args)
    {
        CurrentValue = args.Value?.ToString() ?? string.Empty;

        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(CurrentValue);
        }

        NotifyFieldChanged();
    }

    private void HandleBlur(FocusEventArgs _)
    {
        NotifyFieldChanged();
    }

    private void TogglePassword()
    {
        ShowPassword = !ShowPassword;
    }
}

