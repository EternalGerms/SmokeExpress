@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Identity
@using SmokeExpress.Web.Models
@using System.Collections.Generic
@using System.Linq
@using System.Security.Claims
@using System.Threading
@using System.Threading.Tasks
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Navigation
@inject ApplicationDbContext DbContext
@implements IDisposable

<nav class="app-navbar">
    <div class="header-top container-fluid">
        <div class="brand-area">
            <a class="brand-link" href="">Smoke Express</a>
        </div>

        <div class="header-search" role="search">
            <span class="oi oi-magnifying-glass search-icon" aria-hidden="true"></span>
            <input class="search-input"
                   type="search"
                   placeholder="Buscar produtos, categorias ou marcas..."
                   @bind="headerSearchTerm"
                   @bind:event="oninput"
                   @onkeydown="HandleHeaderSearchKeyDown"
                   aria-label="Buscar produtos" />
            <button type="button"
                    class="search-button"
                    @onclick="SubmitHeaderSearch"
                    aria-label="Executar busca">
                Buscar
            </button>
        </div>

        <div class="header-actions">
            <a class="cart-button" href="/checkout" @onclick="CollapseNavMenu">
                <span class="oi oi-cart" aria-hidden="true"></span>
                <span class="cart-label">Carrinho</span>
                <span class="visually-hidden">Abrir carrinho</span>
            </a>

            <AuthorizeView>
                <Authorized Context="auth">
                    @{ 
                        var effectiveName = currentUserDisplayName ?? GetDisplayName(auth.User);
                        var firstNameForDisplay = GetFirstNameForDisplay(effectiveName);
                    }
                    <div class="dropdown user-dropdown @(isUserMenuOpen ? "show" : string.Empty)"
                         @onfocusin="HandleUserMenuFocusIn"
                         @onfocusout="HandleUserMenuFocusOut">
                        <button class="btn btn-sm header-user-button dropdown-toggle @(isUserMenuOpen ? "show" : string.Empty)"
                                type="button"
                                aria-haspopup="true"
                                aria-expanded="@isUserMenuOpen"
                                @onclick="ToggleUserMenu"
                                @onclick:stopPropagation="true"
                                @onblur="HandleUserMenuBlur"
                                @onfocus="HandleUserMenuFocusIn">
                            <span class="oi oi-person" aria-hidden="true"></span>
                            <span class="user-name">Olá, @firstNameForDisplay</span>
                        </button>
                        <div class="dropdown-menu user-dropdown-menu @(isUserMenuOpen ? "show" : string.Empty)"
                             tabindex="-1"
                             @onclick:stopPropagation="true">
                            <AuthorizeView Roles="Admin">
                                <NavLink class="dropdown-item" href="admin" ActiveClass="" @onclick="CollapseNavMenu">
                                    <span class="oi oi-dashboard" aria-hidden="true"></span> Painel Admin
                                </NavLink>
                                <NavLink class="dropdown-item" href="admin/estatisticas" ActiveClass="" @onclick="CollapseNavMenu">
                                    <span class="oi oi-bar-chart" aria-hidden="true"></span> Estatísticas
                                </NavLink>
                                <div class="dropdown-divider"></div>
                            </AuthorizeView>
                            <NavLink class="dropdown-item" href="account/profile" ActiveClass="" @onclick="CollapseNavMenu">
                                Minha Conta
                            </NavLink>
                            <div class="dropdown-divider"></div>
                            <form class="logout-dropdown-form" method="post" action="/account/logout">
                                <button type="submit" class="dropdown-item" @onclick="CollapseNavMenu">
                                    Sair
                                </button>
                            </form>
                        </div>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="btn btn-sm header-login-button" href="account/login" @onclick="CollapseNavMenu">
                        <span class="oi oi-account-login" aria-hidden="true"></span>
                        Entrar
                    </NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>

    <div class="category-bar">
        <div class="container-fluid category-inner">
            <button class="category-toggle d-lg-none" type="button"
                    aria-expanded="@(!collapseNavMenu)"
                    aria-controls="categoryNav"
                    @onclick="ToggleNavMenu">
                <span class="oi oi-menu" aria-hidden="true"></span>
                Categorias
            </button>

            <div id="categoryNav" class="@CategoryNavWrapperClass">
                <ul class="category-nav">
                    @if (_categorias.Count == 0)
                    {
                        <li class="category-item">
                            <span class="category-pill disabled">Categorias indisponíveis</span>
                        </li>
                    }
                    else
                    {
                        foreach (var categoria in _categorias)
                        {
                            <li class="category-item">
                                <button type="button"
                                        class="category-pill"
                                        @onclick="() => IrParaCategoria(categoria.Id)">
                                    @categoria.Nome
                                </button>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
</nav>

@code {
    private bool collapseNavMenu = true;
    private bool isUserMenuOpen;
    private string? currentUserDisplayName;
    private AuthenticationState? cachedAuthState;
    private CancellationTokenSource? userMenuCloseCts;
    private string headerSearchTerm = string.Empty;
    private IReadOnlyList<Category> _categorias = Array.Empty<Category>();

    private string CategoryNavWrapperClass => collapseNavMenu ? "category-nav-wrapper collapsed" : "category-nav-wrapper expanded";

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
        if (!collapseNavMenu)
        {
            CloseUserMenu();
        }

    }

    private void CollapseNavMenu()
    {
        collapseNavMenu = true;
        CloseUserMenu();
    }

    private void ToggleUserMenu()
    {
        isUserMenuOpen = !isUserMenuOpen;
        if (isUserMenuOpen)
        {
            CancelScheduledUserMenuClose();
            collapseNavMenu = true;
        }
    }

    private void CloseUserMenu()
    {
        isUserMenuOpen = false;
        CancelScheduledUserMenuClose();
    }

    private void HandleUserMenuBlur(FocusEventArgs _)
    {
        ScheduleCloseUserMenu();
    }

    private void HandleUserMenuFocusOut(FocusEventArgs _)
    {
        ScheduleCloseUserMenu();
    }

    private void HandleUserMenuFocusIn(FocusEventArgs _)
    {
        CancelScheduledUserMenuClose();
    }


    [Inject]
    private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    [Inject]
    private UserManager<ApplicationUser> UserManager { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await LoadUserDisplayNameAsync();
        await CarregarCategoriasAsync();
    }

    private async Task CarregarCategoriasAsync()
    {
        try
        {
            _categorias = await DbContext.Categories
                .AsNoTracking()
                .OrderBy(c => c.Nome)
                .ToListAsync();
        }
        catch
        {
            // Se houver erro ao carregar categorias, mantém lista vazia
            _categorias = Array.Empty<Category>();
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        cachedAuthState = await task;
        await LoadUserDisplayNameAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadUserDisplayNameAsync()
    {
        var state = cachedAuthState ?? await AuthStateProvider.GetAuthenticationStateAsync();
        cachedAuthState = state;

        var user = state.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            var identityUser = await UserManager.GetUserAsync(user);
            if (identityUser != null && !string.IsNullOrWhiteSpace(identityUser.NomeCompleto))
            {
                currentUserDisplayName = identityUser.NomeCompleto;
                return;
            }

            currentUserDisplayName = GetDisplayName(user);
        }
        else
        {
            currentUserDisplayName = null;
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        CancelScheduledUserMenuClose();
    }

    private void ScheduleCloseUserMenu()
    {
        CancelScheduledUserMenuClose();
        userMenuCloseCts = new CancellationTokenSource();
        var token = userMenuCloseCts.Token;

        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(150, token);
                await InvokeAsync(() =>
                {
                    isUserMenuOpen = false;
                    StateHasChanged();
                });
            }
            catch (TaskCanceledException)
            {
                // Ignorado
            }
        }, token);
    }

    private void CancelScheduledUserMenuClose()
    {
        if (userMenuCloseCts is null)
        {
            return;
        }

        if (!userMenuCloseCts.IsCancellationRequested)
        {
            userMenuCloseCts.Cancel();
        }

        userMenuCloseCts.Dispose();
        userMenuCloseCts = null;
    }

    private static string GetDisplayName(ClaimsPrincipal? user)
    {
        if (user == null)
        {
            return "Usuário";
        }

        var customName = user.FindFirst("nome")?.Value
            ?? user.FindFirst("name")?.Value
            ?? user.FindFirst("NomeCompleto")?.Value;
        if (!string.IsNullOrWhiteSpace(customName) && !customName.Contains('@'))
        {
            return customName;
        }

        var givenName = user.FindFirst(ClaimTypes.GivenName)?.Value;
        var surname = user.FindFirst(ClaimTypes.Surname)?.Value;
        if (!string.IsNullOrWhiteSpace(givenName) && !string.IsNullOrWhiteSpace(surname))
        {
            return $"{givenName} {surname}".Trim();
        }

        if (!string.IsNullOrWhiteSpace(givenName))
        {
            return givenName;
        }

        var displayName = user.Identity?.Name;
        if (!string.IsNullOrWhiteSpace(displayName))
        {
            var trimmed = displayName.Trim();
            if (!trimmed.Contains('@'))
            {
                return trimmed;
            }
        }

        var email = user.FindFirst(ClaimTypes.Email)?.Value;
        if (!string.IsNullOrWhiteSpace(email))
        {
            var atIndex = email.IndexOf('@');
            return atIndex > 0 ? email[..atIndex] : email;
        }

        return "Usuário";
    }

    private static string GetFirstNameForDisplay(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
        {
            return "Usuário";
        }

        // Extrair apenas o primeiro nome (antes do primeiro espaço)
        var firstName = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() ?? fullName.Trim();
        
        // Limitar a 16 caracteres
        if (firstName.Length > 16)
        {
            return firstName[..16];
        }

        return firstName;
    }

    private void IrParaCategoria(int categoriaId)
    {
        CollapseNavMenu();
        Navigation.NavigateTo($"/produtos?categoria={categoriaId}", forceLoad: false);
    }

    private void SubmitHeaderSearch()
    {
        var termo = headerSearchTerm?.Trim();

        CollapseNavMenu();

        if (string.IsNullOrWhiteSpace(termo))
        {
            Navigation.NavigateTo("/produtos");
            return;
        }

        var encoded = Uri.EscapeDataString(termo);
        Navigation.NavigateTo($"/produtos?search={encoded}");
    }

    private void HandleHeaderSearchKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            SubmitHeaderSearch();
        }
    }

}
